"use strict";var V=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var X=(a,r)=>{for(var t in r)V(a,t,{get:r[t],enumerable:!0})},K=(a,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of G(r))!q.call(a,s)&&s!==t&&V(a,s,{get:()=>r[s],enumerable:!(e=J(r,s))||e.enumerable});return a};var Z=a=>K(V({},"__esModule",{value:!0}),a);var rt={};X(rt,{default:()=>P});module.exports=Z(rt);var l=require("obsidian");var g=require("obsidian"),E=class extends g.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Love Linker Publisher \u8BBE\u7F6E"}),new g.Setting(t).setName("WEBDAV_BASE_URL").setDesc("\u4F8B\u5982 https://rebun.infini-cloud.net/dav\uFF08\u4E00\u822C\u4EE5 /dav \u7ED3\u5C3E\uFF09").addText(n=>n.setPlaceholder("https://...").setValue(this.plugin.settings.webdavBaseUrl).onChange(async i=>{this.plugin.settings.webdavBaseUrl=i.trim(),await this.plugin.saveSettings()})),new g.Setting(t).setName("WEBDAV_USERNAME").setDesc("\u4E91\u76D8\u7684 Connection ID\uFF08\u7528\u4E8E\u767B\u5F55\uFF09").addText(n=>n.setPlaceholder("YOUR_CONNECTION_ID").setValue(this.plugin.settings.webdavUsername).onChange(async i=>{this.plugin.settings.webdavUsername=i.trim(),await this.plugin.saveSettings()})),new g.Setting(t).setName("WEBDAV_PASSWORD").setDesc("\u4E91\u76D8\u7684 Apps Password\uFF08\u5EFA\u8BAE\u4E0D\u8981\u622A\u56FE\u5206\u4EAB\uFF1B\u672C\u63D2\u4EF6\u4F1A\u4FDD\u5B58\u5728\u672C\u5730\u914D\u7F6E\u4E2D\uFF09").addText(n=>{n.inputEl.type="password",n.setPlaceholder("YOUR_APPS_PASSWORD").setValue(this.plugin.settings.webdavPassword).onChange(async i=>{this.plugin.settings.webdavPassword=i.trim(),await this.plugin.saveSettings()})}),new g.Setting(t).setName("\u663E\u793A\u5BC6\u7801").setDesc("\u4EC5\u5F71\u54CD\u5F53\u524D\u8BBE\u7F6E\u9875\u663E\u793A").addToggle(n=>{n.setValue(!1).onChange(i=>{t.querySelectorAll("input[type='password'], input[data-llp-password='true']").forEach(c=>{let p=c;p.type=i?"text":"password"})})});let e=t.querySelector("input[type='password']");e&&e.setAttribute("data-llp-password","true"),new g.Setting(t).setName("WEBDAV_CONTENT_DIR").setDesc("\u8FDC\u7AEF\u5B58\u653E\u6587\u7AE0\u7684\u76EE\u5F55\u540D\uFF08\u901A\u5E38\u4E0D\u7528\u6539\uFF09").addText(n=>n.setPlaceholder("milestones").setValue(this.plugin.settings.webdavContentDir).onChange(async i=>{this.plugin.settings.webdavContentDir=i.trim()||"milestones",await this.plugin.saveSettings()})),new g.Setting(t).setName("WEBDAV_MANIFEST_FILE").setDesc("slug \u6620\u5C04\u8868\u6587\u4EF6\u540D\uFF08\u901A\u5E38\u4E0D\u7528\u6539\uFF09").addText(n=>n.setPlaceholder("manifest.json").setValue(this.plugin.settings.webdavManifestFile).onChange(async i=>{this.plugin.settings.webdavManifestFile=i.trim()||"manifest.json",await this.plugin.saveSettings()})),new g.Setting(t).setName("LOCAL_CONTENT_FOLDER").setDesc("Obsidian \u672C\u5730\u4FDD\u5B58\u6587\u7AE0\u7684\u6587\u4EF6\u5939\uFF08\u76F8\u5BF9 vault \u6839\u76EE\u5F55\uFF09").addText(n=>n.setPlaceholder("milestones").setValue(this.plugin.settings.localContentFolder).onChange(async i=>{this.plugin.settings.localContentFolder=i.trim()||"milestones",await this.plugin.saveSettings()})),new g.Setting(t).setName("\u9ED8\u8BA4\u6269\u5C55\u540D").setDesc("\u65B0\u5EFA\u6587\u4EF6\u65F6\u4F7F\u7528 .md \u6216 .mdx").addDropdown(n=>{n.addOption("mdx",".mdx"),n.addOption("md",".md"),n.setValue(this.plugin.settings.defaultExtension).onChange(async i=>{this.plugin.settings.defaultExtension=i,await this.plugin.saveSettings()})}),new g.Setting(t).setName("\u9ED8\u8BA4 accent").setDesc("\u65B0\u5EFA\u6587\u6863\u65F6\u9ED8\u8BA4\u4F7F\u7528\u7684\u4E3B\u8272").addText(n=>n.setPlaceholder("coral").setValue(this.plugin.settings.defaultAccent).onChange(async i=>{this.plugin.settings.defaultAccent=i.trim()||"coral",await this.plugin.saveSettings()})),new g.Setting(t).setName("accent \u5019\u9009\u5217\u8868").setDesc("\u6BCF\u884C\u4E00\u4E2A\uFF0C\u53EF\u5199\u6210 key|\u4E2D\u6587\u8BF4\u660E\uFF0C\u4F8B\u5982 sea|\u6D77\u84DD").addTextArea(n=>{n.inputEl.rows=6,n.setValue(this.plugin.settings.accentOptions.join(`
`)).onChange(async i=>{this.plugin.settings.accentOptions=i.split(`
`).map(o=>o.trim()).filter(Boolean),await this.plugin.saveSettings()})}),new g.Setting(t).setName("\u9ED8\u8BA4\u5C01\u9762\u94FE\u63A5").setDesc("\u5916\u94FE\u56FE\u5E8A\u9ED8\u8BA4\u503C\uFF0C\u53EF\u7559\u7A7A").addText(n=>n.setPlaceholder("https://your-image-host/cover.svg").setValue(this.plugin.settings.defaultCoverUrl).onChange(async i=>{this.plugin.settings.defaultCoverUrl=i.trim(),await this.plugin.saveSettings()})),new g.Setting(t).setName("\u6D4B\u8BD5\u8FDE\u63A5").setDesc("\u70B9\u51FB\u540E\u5C1D\u8BD5\u8BFB\u53D6\u8FDC\u7AEF manifest.json").addButton(n=>{n.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(async()=>{await this.plugin.testConnection()})});let s=t.createDiv({cls:"love-linker-section"});s.createEl("h3",{text:"\u5B89\u5168\u8BF4\u660E"}),s.createEl("p",{text:"WebDAV \u5BC6\u7801\u4F1A\u4FDD\u5B58\u5728\u672C\u5730\u63D2\u4EF6\u914D\u7F6E\u6587\u4EF6\u4E2D\uFF08\u660E\u6587\uFF09\uFF0C\u8BF7\u81EA\u884C\u8BC4\u4F30\u98CE\u9669\u3002"}),s.createEl("p",{text:"\u4E0D\u8981\u628A\u5BC6\u7801\u63D0\u4EA4\u5230 Git \u6216\u516C\u5F00\u3002"})}};var N={webdavBaseUrl:"",webdavUsername:"",webdavPassword:"",webdavContentDir:"milestones",webdavManifestFile:"manifest.json",localContentFolder:"milestones",defaultExtension:"mdx",defaultAccent:"coral",accentOptions:["coral|\u73CA\u745A\u7EA2","peach|\u6843\u674F","amber|\u7425\u73C0\u9EC4","sea|\u6D77\u84DD","sky|\u5929\u84DD","ink|\u58A8\u9ED1","paper|\u7EB8\u767D"],defaultCoverUrl:"https://your-image-host/cover.svg",manifestPreviewLimit:10};var B=require("obsidian"),Q=/^\d{4}-\d{2}-\d{2}$/,L=a=>{let r=a.getFullYear(),t=String(a.getMonth()+1).padStart(2,"0"),e=String(a.getDate()).padStart(2,"0");return`${r}-${t}-${e}`},D=a=>{if(!Q.test(a))return!1;let r=new Date(`${a}T00:00:00Z`);return Number.isNaN(r.getTime())?!1:r.toISOString().startsWith(a)},b=a=>{let r=a.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");return r.length>0?r:"milestone"},W=a=>a.split(/[,ï¼Œ]/).map(r=>r.trim()).filter(Boolean),v=a=>a.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),tt=a=>!a||a.length===0?"[]":`[${a.map(t=>`"${v(t)}"`).join(", ")}]`,Y=a=>{var p,m,h,d,w;let r=v(a.title),t=v(a.date),e=v((p=a.place)!=null?p:""),s=v((m=a.accent)!=null?m:""),n=v((h=a.cover)!=null?h:""),i=v(a.excerpt),o=tt((d=a.tags)!=null?d:[]),c=v((w=a.visibility)!=null?w:"public");return["---",`title: "${r}"`,`date: "${t}"`,`place: "${e}"`,`accent: "${s}"`,`cover: "${n}"`,`excerpt: "${i}"`,`tags: ${o}`,`visibility: "${c}"`,"---",""].join(`
`)},_=a=>{var t;let r=a.match(/^---\s*\n([\s\S]*?)\n---\s*(?:\n|$)/);if(!r)return{data:null,hasFrontmatter:!1};try{return{data:(t=(0,B.parseYaml)(r[1]))!=null?t:{},hasFrontmatter:!0}}catch(e){return{data:null,hasFrontmatter:!0,error:e}}},j=a=>{let r=a.split(`
`),t=0;for(let e=0;e<r.length;e+=1)if(r[e].trim()==="---"&&(t+=1,t===2))return e;return 0},z=a=>{let r=a.match(/^\d{4}-\d{2}-\d{2}-(.+)$/);return r&&r[1]?r[1]:a};var M=a=>typeof a=="string"&&a.trim().length>0,et=a=>/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(a),st=a=>{var r,t,e;return{title:String((r=a.title)!=null?r:""),date:String((t=a.date)!=null?t:""),excerpt:String((e=a.excerpt)!=null?e:""),place:a.place?String(a.place):void 0,cover:a.cover?String(a.cover):void 0,accent:a.accent?String(a.accent):void 0,tags:Array.isArray(a.tags)?a.tags.map(s=>String(s)):void 0,visibility:a.visibility?String(a.visibility):void 0}},$=(a,r)=>{let t={ok:!1,errors:[],warnings:[],isPrivate:!1};if(!a)return t.errors.push("\u672A\u8BFB\u53D6\u5230 YAML frontmatter\u3002\u8BF7\u5728\u6587\u4EF6\u5F00\u5934\u6DFB\u52A0 --- \u5757\u3002"),t;let e=st(a);return M(e.title)||t.errors.push("\u7F3A\u5C11 title\uFF0C\u6216\u4E0D\u662F\u5B57\u7B26\u4E32\u3002"),(!M(e.date)||!D(e.date))&&t.errors.push("date \u5FC5\u987B\u4E3A YYYY-MM-DD \u4E14\u662F\u6709\u6548\u65E5\u671F\u3002"),M(e.excerpt)||t.errors.push("\u7F3A\u5C11 excerpt\uFF0C\u6216\u4E0D\u662F\u5B57\u7B26\u4E32\u3002"),e.visibility&&e.visibility!=="public"&&e.visibility!=="private"&&t.errors.push("visibility \u53EA\u80FD\u662F public \u6216 private\u3002"),e.visibility==="private"&&(t.isPrivate=!0),a.tags&&!Array.isArray(a.tags)&&t.warnings.push('tags \u5E94\u4E3A\u6570\u7EC4\uFF0C\u4F8B\u5982 ["\u65C5\u9014", "\u6F6E\u58F0"]\u3002'),e.accent&&e.accent.trim()&&!r.map(n=>n.value).includes(e.accent)&&!et(e.accent)&&t.warnings.push("accent \u4E0D\u5728\u8C03\u8272\u677F\u4E2D\uFF08\u6216\u4E0D\u662F #hex\uFF09\uFF0C\u7F51\u7AD9\u53EF\u80FD\u4F1A\u7ED9\u51FA\u8B66\u544A\u3002"),t.ok=t.errors.length===0,t};var u=require("obsidian");var C=class extends u.Modal{constructor(t,e){super(t);this.options=e;this.data={title:"",date:L(new Date),place:"",accent:e.defaultAccent,cover:e.defaultCover,excerpt:"",tags:[],visibility:"public"}}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u65B0\u5EFA\u91CC\u7A0B\u7891\u6587\u6863"}),new u.Setting(t).setName("\u6807\u9898").setDesc("\u5C06\u7528\u4E8E\u9875\u9762\u6807\u9898\u4E0E\u6587\u4EF6\u540D slug").addText(i=>{i.setPlaceholder("\u4F8B\u5982\uFF1A\u7B2C\u4E00\u6B21\u8FDC\u884C").setValue(this.data.title).onChange(o=>{this.data.title=o.trim(),this.updateFileNamePreview()})}),new u.Setting(t).setName("\u65E5\u671F").setDesc("\u683C\u5F0F YYYY-MM-DD\uFF0C\u9ED8\u8BA4\u4ECA\u5929").addText(i=>{i.inputEl.type="date",i.setValue(this.data.date).onChange(o=>{this.data.date=o.trim(),this.updateFileNamePreview()})}),new u.Setting(t).setName("\u5730\u70B9").setDesc("\u53EF\u7559\u7A7A").addText(i=>{i.setPlaceholder("\u4F8B\u5982\uFF1A\u6D77\u8FB9").setValue(this.data.place).onChange(o=>{this.data.place=o.trim()})}),new u.Setting(t).setName("\u4E3B\u8272 (accent)").setDesc("\u6765\u81EA love-linker \u8C03\u8272\u677F\uFF0C\u53EF\u5728\u8BBE\u7F6E\u91CC\u6269\u5C55").addDropdown(i=>{let o=this.options.accentOptions;o.length===0&&i.addOption(this.options.defaultAccent,this.options.defaultAccent),o.forEach(c=>i.addOption(c.value,c.label)),i.setValue(this.data.accent).onChange(c=>{this.data.accent=c})}),new u.Setting(t).setName("\u5C01\u9762 (cover)").setDesc("\u652F\u6301\u5916\u94FE\uFF0C\u4F8B\u5982 https://your-image-host/cover.svg").addText(i=>{i.setPlaceholder("https://...").setValue(this.data.cover).onChange(o=>{this.data.cover=o.trim()})}),new u.Setting(t).setName("\u6458\u8981 (excerpt)").setDesc("\u9996\u9875\u5361\u7247\u6587\u6848\uFF0C\u5FC5\u586B").addTextArea(i=>{i.inputEl.rows=3,i.setPlaceholder("\u5199\u4E00\u53E5\u7B80\u77ED\u5F15\u8A00").setValue(this.data.excerpt).onChange(o=>{this.data.excerpt=o.trim()})}),new u.Setting(t).setName("\u6807\u7B7E (tags)").setDesc("\u9017\u53F7\u5206\u9694\uFF0C\u4F8B\u5982\uFF1A\u65C5\u9014, \u6F6E\u58F0").addText(i=>{i.setPlaceholder("\u65C5\u9014, \u6F6E\u58F0").setValue("").onChange(o=>{this.data.tags=W(o)})}),new u.Setting(t).setName("\u53EF\u89C1\u6027 (visibility)").setDesc("public \u5C06\u51FA\u73B0\u5728\u9996\u9875\uFF0Cprivate \u4F1A\u9ED8\u8BA4\u9690\u85CF").addDropdown(i=>{i.addOption("public","\u516C\u5F00 / public"),i.addOption("private","\u79C1\u5BC6 / private"),i.setValue(this.data.visibility).onChange(o=>{this.data.visibility=o})}),this.fileNamePreviewEl=t.createDiv({cls:"love-linker-muted"}),this.updateFileNamePreview();let e=t.createDiv({cls:"love-linker-row"}),s=e.createEl("button",{text:"\u521B\u5EFA\u6587\u6863"}),n=e.createEl("button",{text:"\u53D6\u6D88"});s.addEventListener("click",async()=>{if(!this.data.title){new u.Notice("\u8BF7\u586B\u5199\u6807\u9898\u3002",3e3);return}if(!this.data.date||!D(this.data.date)){new u.Notice("\u65E5\u671F\u683C\u5F0F\u5FC5\u987B\u4E3A YYYY-MM-DD\uFF0C\u4E14\u662F\u6709\u6548\u65E5\u671F\u3002",4e3);return}if(!this.data.excerpt){new u.Notice("\u6458\u8981\uFF08excerpt\uFF09\u4E3A\u5FC5\u586B\u5B57\u6BB5\u3002",3e3);return}await this.options.onSubmit(this.data)!==!1&&this.close()}),n.addEventListener("click",()=>this.close())}updateFileNamePreview(){if(!this.fileNamePreviewEl)return;let t=b(this.data.title||"milestone"),s=`${this.data.date||L(new Date)}-${t}.${this.options.defaultExtension}`;this.fileNamePreviewEl.setText(`\u6587\u4EF6\u540D\u9884\u89C8\uFF1A${s}`)}},S=class extends u.Modal{constructor(t,e){super(t);this.options=e;this.forcePrivate=!1;this.manifestOnly=!1;this.useCustomFileName=!1;this.slugValue=e.defaultSlug,this.fileNameValue=`${e.defaultSlug}.${e.extension}`}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u8BBE\u7F6E\u6587\u7AE0 slug"});let e=t.createDiv({cls:"love-linker-muted"}),s=t.createDiv({cls:"love-linker-muted"}),n=()=>{let h=/^[a-z0-9-]+$/.test(this.slugValue);e.setText(h?"\u5EFA\u8BAE\u4EC5\u4F7F\u7528\u5C0F\u5199\u5B57\u6BCD / \u6570\u5B57 / \u77ED\u6A2A\u7EBF\u3002":"\u5F53\u524D slug \u5305\u542B\u7279\u6B8A\u5B57\u7B26\uFF0C\u53EF\u80FD\u5BFC\u81F4 URL \u4E0D\u53CB\u597D\u3002")},i=()=>{s.setText(`\u8FDC\u7AEF\u6587\u4EF6\u540D\u9884\u89C8\uFF1A${this.resolveFileName()}`)};new u.Setting(t).setName("Slug").setDesc("\u5C06\u7528\u4E8E\u7F51\u7AD9 URL").addText(h=>{h.setPlaceholder("\u4F8B\u5982\uFF1Afirst-trip").setValue(this.slugValue).onChange(d=>{this.slugValue=d.trim(),this.useCustomFileName||(this.fileNameValue=`${this.slugValue}.${this.options.extension}`),n(),i()})}),new u.Setting(t).setName("\u63A8\u9001\u4E3A private").setDesc("\u4F1A\u5199\u5165\u5F53\u524D\u6587\u4EF6 frontmatter \u7684 visibility").addToggle(h=>{h.setValue(this.forcePrivate).onChange(d=>{this.forcePrivate=d})}),new u.Setting(t).setName("\u9AD8\u7EA7\u9009\u9879").setDesc("\u53EF\u81EA\u5B9A\u4E49\u8FDC\u7AEF\u6587\u4EF6\u540D\u6216\u53EA\u66F4\u65B0 manifest").addToggle(h=>{h.setValue(!1).onChange(d=>{this.useCustomFileName=d,o.style.display=d?"block":"none",i()})});let o=t.createDiv({cls:"love-linker-section"});o.style.display="none",new u.Setting(o).setName("\u81EA\u5B9A\u4E49\u8FDC\u7AEF\u6587\u4EF6\u540D").setDesc("\u4F8B\u5982\uFF1Amy-post.mdx\uFF0C\u4E0D\u586B\u5219\u4F7F\u7528 slug").addText(h=>{h.setPlaceholder(`${this.slugValue}.${this.options.extension}`).setValue(this.fileNameValue).onChange(d=>{this.fileNameValue=d.trim(),i()})}),new u.Setting(o).setName("\u4EC5\u66F4\u65B0 manifest").setDesc("\u4E0D\u4E0A\u4F20\u5F53\u524D\u6587\u6863\uFF0C\u4EC5\u66F4\u65B0 slug -> file \u6620\u5C04").addToggle(h=>{h.setValue(this.manifestOnly).onChange(d=>{this.manifestOnly=d})}),n(),i();let c=t.createDiv({cls:"love-linker-row"}),p=c.createEl("button",{text:"\u7EE7\u7EED"}),m=c.createEl("button",{text:"\u53D6\u6D88"});p.addEventListener("click",()=>{if(!this.slugValue.trim()){new u.Notice("slug \u4E0D\u80FD\u4E3A\u7A7A\u3002",3e3);return}if(/[\\/]/.test(this.resolveFileName())){new u.Notice("\u6587\u4EF6\u540D\u4E0D\u80FD\u5305\u542B\u659C\u6760\u3002",3e3);return}this.options.onSubmit({slug:this.slugValue.trim(),fileName:this.resolveFileName(),forcePrivate:this.forcePrivate,manifestOnly:this.manifestOnly}),this.close()}),m.addEventListener("click",()=>this.close())}resolveFileName(){if(this.useCustomFileName&&this.fileNameValue.trim()){let t=this.fileNameValue.trim();return t.endsWith(`.${this.options.extension}`)||t.includes(".")?t:`${t}.${this.options.extension}`}return`${this.slugValue}.${this.options.extension}`}},k=class extends u.Modal{constructor(t,e){super(t);this.options=e;this.resolved=!1}onOpen(){var i,o;let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:this.options.title}),t.createEl("p",{text:this.options.message});let e=t.createDiv({cls:"love-linker-row"}),s=e.createEl("button",{text:(i=this.options.confirmText)!=null?i:"\u786E\u8BA4"}),n=e.createEl("button",{text:(o=this.options.cancelText)!=null?o:"\u53D6\u6D88"});s.addEventListener("click",()=>this.resolve("confirm")),n.addEventListener("click",()=>this.resolve("cancel"))}onClose(){this.resolved||this.options.onResolve("cancel")}resolve(t){this.resolved=!0,this.options.onResolve(t),this.close()}},F=class extends u.Modal{constructor(t,e){super(t);this.options=e;this.resolved=!1}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Slug \u5DF2\u5B58\u5728"}),t.createEl("p",{text:`\u8FDC\u7AEF\u5DF2\u5B58\u5728 slug: ${this.options.slug}\uFF08\u6587\u4EF6\uFF1A${this.options.existingFile}\uFF09\u3002\u8BF7\u9009\u62E9\u5904\u7406\u65B9\u5F0F\u3002`});let e=t.createDiv({cls:"love-linker-row"}),s=e.createEl("button",{text:"\u8986\u76D6"}),n=e.createEl("button",{text:"\u6539 slug"}),i=e.createEl("button",{text:"\u53D6\u6D88"});s.addEventListener("click",()=>this.resolve("overwrite")),n.addEventListener("click",()=>this.resolve("change")),i.addEventListener("click",()=>this.resolve("cancel"))}onClose(){this.resolved||this.options.onResolve("cancel")}resolve(t){this.resolved=!0,this.options.onResolve(t),this.close()}};var H=require("obsidian"),y="love-linker-publish-panel",T=class extends H.ItemView{constructor(t,e){super(t);this.plugin=e}getViewType(){return y}getDisplayText(){return"Love Linker \u53D1\u5E03\u9762\u677F"}getIcon(){return"paper-plane"}async onOpen(){this.render()}onClose(){this.contentEl.empty()}render(){let{contentEl:t}=this;t.empty(),t.addClass("love-linker-panel");let e=t.createDiv({cls:"love-linker-section"});e.createEl("h3",{text:"\u5F53\u524D\u6587\u4EF6"}),this.fileInfoEl=e.createDiv(),this.validationEl=e.createDiv({cls:"love-linker-muted"});let s=e.createDiv({cls:"love-linker-row"});s.createEl("button",{text:"\u65B0\u5EFA\u6587\u7AE0"}).addEventListener("click",()=>{this.plugin.openNewArticleModal()}),s.createEl("button",{text:"\u63A8\u9001\u5F53\u524D\u6587\u7AE0"}).addEventListener("click",()=>{this.plugin.pushCurrentFile({progress:c=>this.setProgress(c)})});let n=t.createDiv({cls:"love-linker-section"});n.createEl("h3",{text:"\u8FDC\u7AEF\u72B6\u6001"}),this.remoteInfoEl=n.createDiv({cls:"love-linker-muted"});let i=n.createDiv({cls:"love-linker-row"});i.createEl("button",{text:"\u6D4B\u8BD5\u8FDE\u63A5"}).addEventListener("click",()=>{this.plugin.testConnection()}),i.createEl("button",{text:"\u8BFB\u53D6 manifest"}).addEventListener("click",()=>{this.loadManifestPreview()}),this.manifestStatusEl=n.createDiv({cls:"love-linker-muted"}),this.manifestListEl=n.createEl("ul",{cls:"love-linker-manifest-list"});let o=t.createDiv({cls:"love-linker-section"});o.createEl("h3",{text:"\u63A8\u9001\u8FDB\u5EA6"}),this.progressEl=o.createDiv({cls:"love-linker-status"}),this.setProgress("\u7B49\u5F85\u64CD\u4F5C"),this.refresh()}async refresh(){await this.refreshFileStatus(),this.refreshRemoteInfo()}async refreshFileStatus(){if(!this.fileInfoEl||!this.validationEl)return;let t=await this.plugin.getActiveFileStatus();if(this.validationEl.removeClass("love-linker-danger"),!t.file){this.fileInfoEl.setText("\u672A\u6253\u5F00 Markdown/MDX \u6587\u4EF6"),this.validationEl.setText("\u6253\u5F00\u6587\u4EF6\u540E\u53EF\u68C0\u67E5 frontmatter\u3002");return}let e=`${t.file.path}`;if(this.fileInfoEl.setText(`\u5F53\u524D\u6587\u4EF6\uFF1A${e}`),!t.hasFrontmatter){this.validationEl.setText("\u672A\u68C0\u6D4B\u5230 frontmatter\u3002\u8BF7\u5148\u521B\u5EFA YAML \u5757\u3002"),this.validationEl.addClass("love-linker-danger");return}if(t.validation.errors.length>0){this.validationEl.setText(`\u6821\u9A8C\u5931\u8D25\uFF1A${t.validation.errors.join("\uFF1B")}`),this.validationEl.addClass("love-linker-danger");return}let s=t.validation.warnings.length>0?`\uFF08\u63D0\u793A\uFF1A${t.validation.warnings.join("\uFF1B")})`:"",n=t.validation.isPrivate?"\uFF08\u5F53\u524D\u4E3A private\uFF09":"";this.validationEl.setText(`\u6821\u9A8C\u901A\u8FC7 ${n} ${s}`.trim()),this.validationEl.removeClass("love-linker-danger")}refreshRemoteInfo(){if(!this.remoteInfoEl)return;let t=this.plugin.getRemoteInfo();if(!t.baseUrl){this.remoteInfoEl.setText("\u672A\u914D\u7F6E WebDAV\u3002\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u586B\u5199\u3002"),this.remoteInfoEl.addClass("love-linker-danger");return}this.remoteInfoEl.removeClass("love-linker-danger"),this.remoteInfoEl.setText(`Base URL: ${t.baseUrl} | \u76EE\u5F55: ${t.contentDir}`)}setProgress(t){this.progressEl&&this.progressEl.setText(t)}async loadManifestPreview(){if(!this.manifestListEl||!this.manifestStatusEl)return;this.manifestStatusEl.setText("\u6B63\u5728\u62C9\u53D6 manifest..."),this.manifestListEl.empty();let t=await this.plugin.fetchManifestPreview();if(!t){this.manifestStatusEl.setText("\u8BFB\u53D6\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8BBE\u7F6E\u4E0E\u7F51\u7EDC\u3002");return}let e=t.items,s=t.limit;this.manifestStatusEl.setText(`\u5DF2\u8BFB\u53D6\u524D ${Math.min(e.length,s)} \u6761\uFF1A`),e.slice(0,s).forEach(n=>{var o;let i=(o=this.manifestListEl)==null?void 0:o.createEl("li");i==null||i.setText(`${n.slug} \u2192 ${n.file}`)})}};var O=require("obsidian"),f=class extends Error{constructor(r,t){super(r),this.name="WebDavError",this.status=t}},it=a=>a.trim().replace(/\/+$/,""),nt=a=>a.trim().replace(/^\/+|\/+$/g,""),at=a=>a.split("/").map(r=>encodeURIComponent(r)).join("/"),A=class{constructor(r){this.getSettings=r}buildUrl(r){let t=this.getSettings(),e=it(t.webdavBaseUrl);if(!e)throw new f("\u672A\u914D\u7F6E WEBDAV_BASE_URL\u3002\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u586B\u5199\u3002",0);let s=r.map(n=>nt(n)).filter(Boolean).map(at).join("/");return`${e}/${s}`}getAuthHeader(){let r=this.getSettings();if(!r.webdavUsername||!r.webdavPassword)throw new f("\u672A\u914D\u7F6E WEBDAV_USERNAME \u6216 WEBDAV_PASSWORD\u3002",0);return`Basic ${Buffer.from(`${r.webdavUsername}:${r.webdavPassword}`,"utf8").toString("base64")}`}async getText(r){let t=this.buildUrl(r),e=await(0,O.requestUrl)({url:t,method:"GET",headers:{Authorization:this.getAuthHeader()}});if(e.status<200||e.status>=300)throw new f(`WebDAV \u8BF7\u6C42\u5931\u8D25 (${e.status})`,e.status);return e.text}async getJson(r){let t=await this.getText(r);try{return JSON.parse(t)}catch(e){throw new f("\u8FDC\u7AEF\u8FD4\u56DE\u7684 JSON \u89E3\u6790\u5931\u8D25\u3002",0)}}async putText(r,t,e){let s=this.buildUrl(r),n=await(0,O.requestUrl)({url:s,method:"PUT",body:t,contentType:e,headers:{Authorization:this.getAuthHeader()}});if(n.status<200||n.status>=300)throw new f(`WebDAV \u4E0A\u4F20\u5931\u8D25 (${n.status})`,n.status)}};var P=class extends l.Plugin{constructor(){super(...arguments);this.settings=N}async onload(){await this.loadSettings(),this.webdav=new A(()=>this.settings),this.addSettingTab(new E(this.app,this)),this.registerView(y,t=>(this.publishView=new T(t,this),this.publishView)),this.addRibbonIcon("paper-plane","\u6253\u5F00 Love Linker \u53D1\u5E03\u9762\u677F",()=>{this.activatePublishView()}),this.addCommand({id:"love-linker-open-panel",name:"\u6253\u5F00\u53D1\u5E03\u9762\u677F",callback:()=>this.activatePublishView()}),this.addCommand({id:"love-linker-new-article",name:"\u65B0\u5EFA\u6587\u7AE0",callback:()=>this.openNewArticleModal()}),this.addCommand({id:"love-linker-push-current",name:"\u63A8\u9001\u5F53\u524D\u6587\u6863\u5230 WebDAV",callback:()=>this.pushCurrentFile()}),this.registerEvent(this.app.workspace.on("file-menu",(t,e)=>{e instanceof l.TFile&&this.isMarkdownFile(e)&&t.addItem(s=>{s.setTitle("\u63A8\u9001\u5230 WebDAV").setIcon("paper-plane").onClick(()=>this.pushCurrentFile({file:e}))})})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{var t;(t=this.publishView)==null||t.refreshFileStatus()})),this.registerEvent(this.app.metadataCache.on("changed",t=>{var s;let e=this.app.workspace.getActiveFile();e&&t.path===e.path&&((s=this.publishView)==null||s.refreshFileStatus())}))}onunload(){this.app.workspace.detachLeavesOfType(y)}async loadSettings(){this.settings=Object.assign({},N,await this.loadData())}async saveSettings(){var t;await this.saveData(this.settings),(t=this.publishView)==null||t.refreshRemoteInfo()}getRemoteInfo(){return{baseUrl:this.settings.webdavBaseUrl.trim(),contentDir:this.settings.webdavContentDir.trim()||"milestones"}}async activatePublishView(){var e;let t=this.app.workspace.getRightLeaf(!1);if(!t){new l.Notice("\u65E0\u6CD5\u6253\u5F00\u4FA7\u8FB9\u680F\uFF0C\u8BF7\u68C0\u67E5\u5DE5\u4F5C\u533A\u5E03\u5C40\u3002",3e3);return}await t.setViewState({type:y,active:!0}),this.publishView=t.view,(e=this.publishView)==null||e.refresh()}getAccentOptions(){let t=[];for(let s of this.settings.accentOptions){let n=s.trim();if(!n)continue;let[i,o]=n.split("|").map(c=>c.trim());i&&t.push({value:i,label:o||i})}return t.length===0&&t.push({value:this.settings.defaultAccent,label:this.settings.defaultAccent}),!t.some(s=>s.value===this.settings.defaultAccent)&&this.settings.defaultAccent.trim()&&t.unshift({value:this.settings.defaultAccent,label:`${this.settings.defaultAccent}\uFF08\u9ED8\u8BA4\uFF09`}),t}async openNewArticleModal(){new C(this.app,{accentOptions:this.getAccentOptions(),defaultAccent:this.settings.defaultAccent,defaultCover:this.settings.defaultCoverUrl||"https://your-image-host/cover.svg",defaultExtension:this.settings.defaultExtension,onSubmit:async e=>this.createNewArticle(e)}).open()}async createNewArticle(t){var h;let e=this.settings.localContentFolder.trim()||"milestones",s=b(t.title),n=`${t.date}-${s}.${this.settings.defaultExtension}`,i=(0,l.normalizePath)(`${e}/${n}`);if(this.app.vault.getAbstractFileByPath(i))return new l.Notice("\u6587\u4EF6\u5DF2\u5B58\u5728\uFF0C\u8BF7\u4FEE\u6539\u6807\u9898\u6216\u65E5\u671F\u3002",4e3),!1;await this.ensureFolder(e);let o=Y({title:t.title,date:t.date,place:t.place,accent:t.accent,cover:t.cover||this.settings.defaultCoverUrl,excerpt:t.excerpt,tags:t.tags,visibility:t.visibility}),c=await this.app.vault.create(i,o),p=this.app.workspace.getLeaf(!0);await p.openFile(c,{active:!0});let m=p.view instanceof l.MarkdownView?p.view:null;if(m){let d=j(o),w=d>=0?d+1:0;m.editor.setCursor({line:w,ch:0}),m.editor.focus()}return new l.Notice("\u5DF2\u521B\u5EFA\u65B0\u6587\u6863\u3002",3e3),(h=this.publishView)==null||h.refreshFileStatus(),!0}async pushCurrentFile(t){var I,R,U;let e=(I=t==null?void 0:t.progress)!=null?I:()=>{},s=(R=t==null?void 0:t.file)!=null?R:this.app.workspace.getActiveFile();if(!s||!this.isMarkdownFile(s)){new l.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Markdown/MDX \u6587\u4EF6\u3002",3e3);return}await this.saveFileIfOpen(s),e("\u6B63\u5728\u89E3\u6790 frontmatter...");let n=await this.app.vault.read(s),i=await this.readFrontmatter(s,n);if(!i.hasFrontmatter){new l.Notice("\u672A\u68C0\u6D4B\u5230 frontmatter\uFF0C\u8BF7\u5148\u521B\u5EFA YAML \u5757\u3002",4e3);return}if(i.error||!i.data){new l.Notice("frontmatter \u89E3\u6790\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5 YAML \u683C\u5F0F\u3002",4e3);return}let o=$(i.data,this.getAccentOptions());if(!o.ok){new l.Notice(`\u6821\u9A8C\u5931\u8D25\uFF1A${o.errors.join("\uFF1B")}`,5e3);return}o.warnings.length>0&&new l.Notice(`\u63D0\u793A\uFF1A${o.warnings.join("\uFF1B")}`,4e3),o.isPrivate&&new l.Notice("\u8BE5\u6587\u7AE0\u4E3A private\uFF0C\u7F51\u7AD9\u53EF\u80FD\u4E0D\u4F1A\u751F\u6210\u6216\u51FA\u73B0\u5728\u9996\u9875\u3002",5e3);let c=s.extension.toLowerCase()==="md"?"md":"mdx",p=await this.promptSlug(this.suggestSlug(s,i.data),c);if(!p)return;p.forcePrivate&&(e("\u6B63\u5728\u66F4\u65B0 visibility \u4E3A private..."),await this.updateVisibility(s,"private"),await this.saveFileIfOpen(s)),e("\u6B63\u5728\u62C9\u53D6 manifest...");let m=await this.fetchManifestWithPrompt();if(!m)return;let h=await this.applySlugToManifest(m.items,p,c);if(!h)return;p=h.slugResult;let d=JSON.stringify({items:h.items},null,2)+`
`,w=!1;if(p.manifestOnly)e("\u5DF2\u8DF3\u8FC7\u6587\u6863\u4E0A\u4F20\uFF08\u4EC5\u66F4\u65B0 manifest\uFF09");else{e("\u6B63\u5728\u4E0A\u4F20\u6587\u6863...");try{let x=await this.app.vault.read(s);await this.webdav.putText([this.settings.webdavContentDir,p.fileName],x,"text/markdown; charset=utf-8"),w=!0,new l.Notice("\u6587\u6863\u5DF2\u4E0A\u4F20\u3002",3e3)}catch(x){new l.Notice(this.formatWebDavError(x,"\u4E0A\u4F20\u6587\u6863"),5e3);return}}e("\u6B63\u5728\u66F4\u65B0 manifest...");try{await this.webdav.putText([this.settings.webdavContentDir,this.settings.webdavManifestFile],d,"application/json; charset=utf-8"),new l.Notice("manifest \u5DF2\u66F4\u65B0\uFF0C\u7F51\u7AD9\u5C06\u5728 ISR \u5468\u671F\u5185\u81EA\u52A8\u5237\u65B0\u3002",4e3)}catch(x){w?new l.Notice("\u8FDC\u7AEF manifest \u66F4\u65B0\u5931\u8D25\uFF0C\u7F51\u7AD9\u53EF\u80FD\u65E0\u6CD5\u8BBF\u95EE\u8BE5\u6587\u7AE0\u3002\u8BF7\u91CD\u8BD5\u6216\u624B\u52A8\u4FEE\u590D\u3002",6e3):new l.Notice(this.formatWebDavError(x,"\u66F4\u65B0 manifest"),5e3);return}e("\u63A8\u9001\u5B8C\u6210"),(U=this.publishView)==null||U.loadManifestPreview()}async testConnection(){try{return await this.webdav.getText([this.settings.webdavContentDir,this.settings.webdavManifestFile]),new l.Notice("\u8FDE\u63A5\u6210\u529F\u3002",3e3),!0}catch(t){return new l.Notice(this.formatWebDavError(t,"\u6D4B\u8BD5\u8FDE\u63A5"),5e3),!1}}async fetchManifestPreview(){try{let t=await this.webdav.getJson([this.settings.webdavContentDir,this.settings.webdavManifestFile]);return{items:this.normalizeManifestItems(t.items),limit:this.settings.manifestPreviewLimit}}catch(t){return new l.Notice(this.formatWebDavError(t,"\u8BFB\u53D6 manifest"),5e3),null}}async getActiveFileStatus(){let t=this.app.workspace.getActiveFile();if(!t||!this.isMarkdownFile(t))return{file:null,hasFrontmatter:!1,validation:{ok:!1,errors:[],warnings:[],isPrivate:!1}};let e=await this.readFrontmatter(t);if(!e.hasFrontmatter)return{file:t,hasFrontmatter:!1,validation:{ok:!1,errors:[],warnings:[],isPrivate:!1}};if(e.error||!e.data)return{file:t,hasFrontmatter:!0,validation:{ok:!1,errors:["frontmatter \u89E3\u6790\u5931\u8D25"],warnings:[],isPrivate:!1}};let s=$(e.data,this.getAccentOptions());return{file:t,hasFrontmatter:!0,validation:s}}async saveFileIfOpen(t){var s;let e=this.app.workspace.getActiveViewOfType(l.MarkdownView);((s=e==null?void 0:e.file)==null?void 0:s.path)===t.path&&await e.save()}async readFrontmatter(t,e){var o;let s=(o=this.app.metadataCache.getFileCache(t))==null?void 0:o.frontmatter;if(s&&Object.keys(s).length>0)return{data:s,hasFrontmatter:!0,error:null};let n=e!=null?e:await this.app.vault.read(t),i=_(n);return{data:i.data,hasFrontmatter:i.hasFrontmatter,error:i.error}}async ensureFolder(t){let e=(0,l.normalizePath)(t);this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}isMarkdownFile(t){let e=t.extension.toLowerCase();return e==="md"||e==="mdx"}suggestSlug(t,e){let s=z(t.basename);if(s&&s!==t.basename)return b(s);let n=e.title?String(e.title):"";return b(n||s)}async promptSlug(t,e){return await new Promise(s=>{let n=!1,i=new S(this.app,{defaultSlug:t,extension:e,onSubmit:o=>{n=!0,s(o)}});i.onClose=()=>{n||s(null)},i.open()})}async promptConfirm(t,e){return await new Promise(s=>{new k(this.app,{title:t,message:e,confirmText:"\u662F",cancelText:"\u5426",onResolve:s}).open()})}async promptConflict(t,e){return await new Promise(s=>{new F(this.app,{slug:t,existingFile:e,onResolve:s}).open()})}async fetchManifestWithPrompt(){try{let t=await this.webdav.getJson([this.settings.webdavContentDir,this.settings.webdavManifestFile]);return{items:this.normalizeManifestItems(t.items)}}catch(t){return t instanceof f&&t.status===404?await this.promptConfirm("\u672A\u627E\u5230 manifest","\u8FDC\u7AEF\u672A\u627E\u5230 manifest.json\uFF0C\u662F\u5426\u521B\u5EFA\u65B0\u7684 manifest\uFF1F")==="confirm"?{items:[]}:null:(new l.Notice(this.formatWebDavError(t,"\u8BFB\u53D6 manifest"),5e3),null)}}normalizeManifestItems(t){return Array.isArray(t)?t.map(e=>{var s,n;return{...e,slug:String((s=e.slug)!=null?s:"").trim(),file:String((n=e.file)!=null?n:"").trim()}}).filter(e=>e.slug&&e.file).sort((e,s)=>e.slug.localeCompare(s.slug)):[]}async applySlugToManifest(t,e,s){let n=e,i=[...t];for(;;){let c=i.find(m=>m.slug===n.slug);if(!c)break;let p=await this.promptConflict(n.slug,c.file);if(p==="cancel")return null;if(p==="change"){let m=await this.promptSlug(n.slug,s);if(!m)return null;n=m;continue}if(p==="overwrite"){c.file=n.fileName;break}}return i.some(c=>c.slug===n.slug)||i.push({slug:n.slug,file:n.fileName}),{items:this.normalizeManifestItems(i),slugResult:n}}async updateVisibility(t,e){await this.app.fileManager.processFrontMatter(t,s=>{s.visibility=e})}formatWebDavError(t,e){return t instanceof f?t.status===401||t.status===403?`${e}\u5931\u8D25\uFF1A\u9274\u6743\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7528\u6237\u540D/\u5BC6\u7801\u3002`:t.status===404?`${e}\u5931\u8D25\uFF1A\u672A\u627E\u5230 manifest.json\u3002`:t.status?`${e}\u5931\u8D25\uFF1AHTTP ${t.status}`:`${e}\u5931\u8D25\uFF1A${t.message}`:t instanceof Error?`${e}\u5931\u8D25\uFF1A${t.message}`:`${e}\u5931\u8D25\uFF1A\u672A\u77E5\u9519\u8BEF\u3002`}};
