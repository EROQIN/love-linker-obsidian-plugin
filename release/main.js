"use strict";var lt=Object.defineProperty;var yt=Object.getOwnPropertyDescriptor;var xt=Object.getOwnPropertyNames;var Dt=Object.prototype.hasOwnProperty;var Ft=(r,o)=>{for(var t in o)lt(r,t,{get:o[t],enumerable:!0})},Tt=(r,o,t,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of xt(o))!Dt.call(r,s)&&s!==t&&lt(r,s,{get:()=>o[s],enumerable:!(e=yt(o,s))||e.enumerable});return r};var Ct=r=>Tt(lt({},"__esModule",{value:!0}),r);var Rt={};Ft(Rt,{default:()=>nt});module.exports=Ct(Rt);var u=require("obsidian");var E=require("obsidian"),G=class extends E.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Love Linker Publisher \u8BBE\u7F6E"}),new E.Setting(t).setName("WEBDAV_BASE_URL").setDesc("\u4F8B\u5982 https://rebun.infini-cloud.net/dav\uFF08\u4E00\u822C\u4EE5 /dav \u7ED3\u5C3E\uFF09").addText(i=>i.setPlaceholder("https://...").setValue(this.plugin.settings.webdavBaseUrl).onChange(async a=>{this.plugin.settings.webdavBaseUrl=a.trim(),await this.plugin.saveSettings()})),new E.Setting(t).setName("WEBDAV_USERNAME").setDesc("\u4E91\u76D8\u7684 Connection ID\uFF08\u7528\u4E8E\u767B\u5F55\uFF09").addText(i=>i.setPlaceholder("YOUR_CONNECTION_ID").setValue(this.plugin.settings.webdavUsername).onChange(async a=>{this.plugin.settings.webdavUsername=a.trim(),await this.plugin.saveSettings()})),new E.Setting(t).setName("WEBDAV_PASSWORD").setDesc("\u4E91\u76D8\u7684 Apps Password\uFF08\u5EFA\u8BAE\u4E0D\u8981\u622A\u56FE\u5206\u4EAB\uFF1B\u672C\u63D2\u4EF6\u4F1A\u4FDD\u5B58\u5728\u672C\u5730\u914D\u7F6E\u4E2D\uFF09").addText(i=>{i.inputEl.type="password",i.setPlaceholder("YOUR_APPS_PASSWORD").setValue(this.plugin.settings.webdavPassword).onChange(async a=>{this.plugin.settings.webdavPassword=a.trim(),await this.plugin.saveSettings()})}),new E.Setting(t).setName("\u663E\u793A\u5BC6\u7801").setDesc("\u4EC5\u5F71\u54CD\u5F53\u524D\u8BBE\u7F6E\u9875\u663E\u793A").addToggle(i=>{i.setValue(!1).onChange(a=>{t.querySelectorAll("input[type='password'], input[data-llp-password='true']").forEach(l=>{let d=l;d.type=a?"text":"password"})})});let e=t.querySelector("input[type='password']");e&&e.setAttribute("data-llp-password","true"),new E.Setting(t).setName("WEBDAV_CONTENT_DIR").setDesc("\u8FDC\u7AEF\u5B58\u653E\u6587\u7AE0\u7684\u76EE\u5F55\u540D\uFF08\u901A\u5E38\u4E0D\u7528\u6539\uFF09").addText(i=>i.setPlaceholder("milestones").setValue(this.plugin.settings.webdavContentDir).onChange(async a=>{this.plugin.settings.webdavContentDir=a.trim()||"milestones",await this.plugin.saveSettings()})),new E.Setting(t).setName("WEBDAV_MANIFEST_FILE").setDesc("slug \u6620\u5C04\u8868\u6587\u4EF6\u540D\uFF08\u901A\u5E38\u4E0D\u7528\u6539\uFF09").addText(i=>i.setPlaceholder("manifest.json").setValue(this.plugin.settings.webdavManifestFile).onChange(async a=>{this.plugin.settings.webdavManifestFile=a.trim()||"manifest.json",await this.plugin.saveSettings()})),new E.Setting(t).setName("WEBDAV_TRASH_DIR").setDesc("\u5F7B\u5E95\u5220\u9664\u65F6\u7684\u56DE\u6536\u7AD9\u76EE\u5F55\u540D\uFF08\u76F8\u5BF9 WEBDAV_CONTENT_DIR\uFF09").addText(i=>i.setPlaceholder("_trash").setValue(this.plugin.settings.webdavTrashDir).onChange(async a=>{this.plugin.settings.webdavTrashDir=a.trim()||"_trash",await this.plugin.saveSettings()})),new E.Setting(t).setName("LOCAL_CONTENT_FOLDER").setDesc("Obsidian \u672C\u5730\u4FDD\u5B58\u6587\u7AE0\u7684\u6587\u4EF6\u5939\uFF08\u76F8\u5BF9 vault \u6839\u76EE\u5F55\uFF09").addText(i=>i.setPlaceholder("milestones").setValue(this.plugin.settings.localContentFolder).onChange(async a=>{this.plugin.settings.localContentFolder=a.trim()||"milestones",await this.plugin.saveSettings()})),new E.Setting(t).setName("\u9ED8\u8BA4\u6269\u5C55\u540D").setDesc("\u65B0\u5EFA\u6587\u4EF6\u65F6\u4F7F\u7528 .md").addDropdown(i=>{i.addOption("md",".md"),i.setValue(this.plugin.settings.defaultExtension).onChange(async a=>{this.plugin.settings.defaultExtension=a,await this.plugin.saveSettings()})}),new E.Setting(t).setName("\u9ED8\u8BA4 accent").setDesc("\u65B0\u5EFA\u6587\u6863\u65F6\u9ED8\u8BA4\u4F7F\u7528\u7684\u4E3B\u8272").addText(i=>i.setPlaceholder("coral").setValue(this.plugin.settings.defaultAccent).onChange(async a=>{this.plugin.settings.defaultAccent=a.trim()||"coral",await this.plugin.saveSettings()})),new E.Setting(t).setName("accent \u5019\u9009\u5217\u8868").setDesc("\u6BCF\u884C\u4E00\u4E2A\uFF0C\u53EF\u5199\u6210 key|\u4E2D\u6587\u8BF4\u660E\uFF0C\u4F8B\u5982 sea|\u6D77\u84DD").addTextArea(i=>{i.inputEl.rows=6,i.setValue(this.plugin.settings.accentOptions.join(`
`)).onChange(async a=>{this.plugin.settings.accentOptions=a.split(`
`).map(n=>n.trim()).filter(Boolean),await this.plugin.saveSettings()})}),new E.Setting(t).setName("\u9ED8\u8BA4\u5C01\u9762\u94FE\u63A5").setDesc("\u5916\u94FE\u56FE\u5E8A\u9ED8\u8BA4\u503C\uFF0C\u53EF\u7559\u7A7A").addText(i=>i.setPlaceholder("https://your-image-host/cover.svg").setValue(this.plugin.settings.defaultCoverUrl).onChange(async a=>{this.plugin.settings.defaultCoverUrl=a.trim(),await this.plugin.saveSettings()})),new E.Setting(t).setName("\u542F\u52A8\u65F6\u81EA\u52A8\u6253\u5F00\u53D1\u5E03\u9762\u677F").setDesc("\u9ED8\u8BA4\u5F00\u542F\uFF0C\u53EF\u5728\u53F3\u4FA7\u5E38\u9A7B\u663E\u793A").addToggle(i=>{i.setValue(this.plugin.settings.autoOpenPanel).onChange(async a=>{this.plugin.settings.autoOpenPanel=a,await this.plugin.saveSettings()})}),new E.Setting(t).setName("\u6D4B\u8BD5\u8FDE\u63A5").setDesc("\u70B9\u51FB\u540E\u68C0\u6D4B WebDAV \u662F\u5426\u53EF\u8FDE\u63A5").addButton(i=>{i.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(async()=>{await this.plugin.testConnection()})});let s=t.createDiv({cls:"love-linker-section"});s.createEl("h3",{text:"\u5B89\u5168\u8BF4\u660E"}),s.createEl("p",{text:"WebDAV \u5BC6\u7801\u4F1A\u4FDD\u5B58\u5728\u672C\u5730\u63D2\u4EF6\u914D\u7F6E\u6587\u4EF6\u4E2D\uFF08\u660E\u6587\uFF09\uFF0C\u8BF7\u81EA\u884C\u8BC4\u4F30\u98CE\u9669\u3002"}),s.createEl("p",{text:"\u4E0D\u8981\u628A\u5BC6\u7801\u63D0\u4EA4\u5230 Git \u6216\u516C\u5F00\u3002"})}};var ot={webdavBaseUrl:"",webdavUsername:"",webdavPassword:"",webdavContentDir:"milestones",webdavManifestFile:"manifest.json",webdavTrashDir:"_trash",localContentFolder:"milestones",defaultExtension:"md",defaultAccent:"coral",accentOptions:["coral|\u73CA\u745A\u7EA2","peach|\u6843\u674F","amber|\u7425\u73C0\u9EC4","sea|\u6D77\u84DD","sky|\u5929\u84DD","ink|\u58A8\u9ED1","paper|\u7EB8\u767D"],defaultCoverUrl:"",manifestPreviewLimit:10,autoOpenPanel:!0};var ft=require("obsidian"),kt=/^\d{4}-\d{2}-\d{2}$/,V=r=>{let o=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0"),e=String(r.getDate()).padStart(2,"0");return`${o}-${t}-${e}`},R=r=>{if(!kt.test(r))return!1;let o=new Date(`${r}T00:00:00Z`);return Number.isNaN(o.getTime())?!1:o.toISOString().startsWith(r)},O=r=>{let o=r.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");return o.length>0?o:"milestone"},I=r=>r.split(/[,ï¼Œ]/).map(o=>o.trim()).filter(Boolean),N=r=>r.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),At=r=>!r||r.length===0?"[]":`[${r.map(t=>`"${N(t)}"`).join(", ")}]`,gt=r=>{var d,h,m,f,b;let o=N(r.title),t=N(r.date),e=N((d=r.place)!=null?d:""),s=N((h=r.accent)!=null?h:""),i=N((m=r.cover)!=null?m:""),a=N(r.excerpt),n=At((f=r.tags)!=null?f:[]),l=N((b=r.visibility)!=null?b:"public");return["---",`title: "${o}"`,`date: "${t}"`,`place: "${e}"`,`accent: "${s}"`,`cover: "${i}"`,`excerpt: "${a}"`,`tags: ${n}`,`visibility: "${l}"`,"---",""].join(`
`)},vt=r=>{var t;let o=r.match(/^---\s*\n([\s\S]*?)\n---\s*(?:\n|$)/);if(!o)return{data:null,hasFrontmatter:!1};try{return{data:(t=(0,ft.parseYaml)(o[1]))!=null?t:{},hasFrontmatter:!0}}catch(e){return{data:null,hasFrontmatter:!0,error:e}}},wt=r=>{let o=r.split(`
`),t=0;for(let e=0;e<o.length;e+=1)if(o[e].trim()==="---"&&(t+=1,t===2))return e;return 0},ct=r=>{let o=r.match(/^\d{4}-\d{2}-\d{2}-(.+)$/);return o&&o[1]?o[1]:r};var ut=r=>typeof r=="string"&&r.trim().length>0,Vt=r=>/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(r),Y=r=>{var o,t,e;return{title:String((o=r.title)!=null?o:""),date:String((t=r.date)!=null?t:""),excerpt:String((e=r.excerpt)!=null?e:""),place:r.place?String(r.place):void 0,cover:r.cover?String(r.cover):void 0,accent:r.accent?String(r.accent):void 0,tags:Array.isArray(r.tags)?r.tags.map(s=>String(s)):void 0,visibility:r.visibility?String(r.visibility):void 0}},ht=(r,o)=>{let t={ok:!1,errors:[],warnings:[],isPrivate:!1};if(!r)return t.errors.push("\u672A\u8BFB\u53D6\u5230 YAML frontmatter\u3002\u8BF7\u5728\u6587\u4EF6\u5F00\u5934\u6DFB\u52A0 --- \u5757\u3002"),t;let e=Y(r);return ut(e.title)||t.errors.push("\u7F3A\u5C11 title\uFF0C\u6216\u4E0D\u662F\u5B57\u7B26\u4E32\u3002"),(!ut(e.date)||!R(e.date))&&t.errors.push("date \u5FC5\u987B\u4E3A YYYY-MM-DD \u4E14\u662F\u6709\u6548\u65E5\u671F\u3002"),ut(e.excerpt)||t.errors.push("\u7F3A\u5C11 excerpt\uFF0C\u6216\u4E0D\u662F\u5B57\u7B26\u4E32\u3002"),e.visibility&&e.visibility!=="public"&&e.visibility!=="private"&&t.errors.push("visibility \u53EA\u80FD\u662F public \u6216 private\u3002"),e.visibility==="private"&&(t.isPrivate=!0),r.tags&&!Array.isArray(r.tags)&&t.warnings.push('tags \u5E94\u4E3A\u6570\u7EC4\uFF0C\u4F8B\u5982 ["\u65C5\u9014", "\u6F6E\u58F0"]\u3002'),e.accent&&e.accent.trim()&&!o.map(i=>i.value).includes(e.accent)&&!Vt(e.accent)&&t.warnings.push("accent \u4E0D\u5728\u8C03\u8272\u677F\u4E2D\uFF08\u6216\u4E0D\u662F #hex\uFF09\uFF0C\u7F51\u7AD9\u53EF\u80FD\u4F1A\u7ED9\u51FA\u8B66\u544A\u3002"),t.ok=t.errors.length===0,t};var g=require("obsidian");var K=class extends g.Modal{constructor(t,e){super(t);this.options=e;let s=V(new Date);this.data={title:"",date:s,fileName:"",place:"",accent:e.defaultAccent,cover:e.defaultCover,excerpt:"",tags:[],visibility:"public"},this.defaultFileNameBase=this.buildDefaultFileNameBase(s),this.data.fileName=this.defaultFileNameBase}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u65B0\u5EFA\u91CC\u7A0B\u7891\u6587\u6863"}),new g.Setting(t).setName("\u6807\u9898").setDesc("\u5C06\u7528\u4E8E\u9875\u9762\u6807\u9898").addText(a=>{a.setPlaceholder("\u4F8B\u5982\uFF1A\u7B2C\u4E00\u6B21\u8FDC\u884C").setValue(this.data.title).onChange(n=>{this.data.title=n.trim(),this.updateFileNamePreview()})}),new g.Setting(t).setName("\u65E5\u671F").setDesc("\u683C\u5F0F YYYY-MM-DD\uFF0C\u9ED8\u8BA4\u4ECA\u5929").addText(a=>{a.inputEl.type="date",a.setValue(this.data.date).onChange(n=>{this.data.date=n.trim();let l=this.buildDefaultFileNameBase(this.data.date);this.data.fileName.trim()===this.defaultFileNameBase&&(this.defaultFileNameBase=l,this.data.fileName=l),this.updateFileNamePreview()})}),new g.Setting(t).setName("\u6587\u4EF6\u540D").setDesc("\u53EF\u81EA\u5B9A\u4E49\uFF0C\u4E0D\u4F1A\u968F\u6807\u9898\u81EA\u52A8\u53D8\u5316").addText(a=>{a.setPlaceholder(this.defaultFileNameBase).setValue(this.data.fileName).onChange(n=>{this.data.fileName=n.trim(),this.updateFileNamePreview()})}),new g.Setting(t).setName("\u5730\u70B9").setDesc("\u53EF\u7559\u7A7A").addText(a=>{a.setPlaceholder("\u4F8B\u5982\uFF1A\u6D77\u8FB9").setValue(this.data.place).onChange(n=>{this.data.place=n.trim()})}),new g.Setting(t).setName("\u4E3B\u8272 (accent)").setDesc("\u6765\u81EA love-linker \u8C03\u8272\u677F\uFF0C\u53EF\u5728\u8BBE\u7F6E\u91CC\u6269\u5C55").addDropdown(a=>{let n=this.options.accentOptions;n.length===0&&a.addOption(this.options.defaultAccent,this.options.defaultAccent),n.forEach(l=>a.addOption(l.value,l.label)),a.setValue(this.data.accent).onChange(l=>{this.data.accent=l})}),new g.Setting(t).setName("\u5C01\u9762 (cover)").setDesc("\u652F\u6301\u5916\u94FE\uFF0C\u4F8B\u5982 https://your-image-host/cover.svg").addText(a=>{a.setPlaceholder("https://...").setValue(this.data.cover).onChange(n=>{this.data.cover=n.trim()})}),new g.Setting(t).setName("\u6458\u8981 (excerpt)").setDesc("\u9996\u9875\u5361\u7247\u6587\u6848\uFF0C\u53EF\u7559\u7A7A").addTextArea(a=>{a.inputEl.rows=3,a.setPlaceholder("\u5199\u4E00\u53E5\u7B80\u77ED\u5F15\u8A00").setValue(this.data.excerpt).onChange(n=>{this.data.excerpt=n.trim()})}),new g.Setting(t).setName("\u6807\u7B7E (tags)").setDesc("\u9017\u53F7\u5206\u9694\uFF0C\u4F8B\u5982\uFF1A\u65C5\u9014, \u6F6E\u58F0").addText(a=>{a.setPlaceholder("\u65C5\u9014, \u6F6E\u58F0").setValue("").onChange(n=>{this.data.tags=I(n)})}),new g.Setting(t).setName("\u53EF\u89C1\u6027 (visibility)").setDesc("public \u5C06\u51FA\u73B0\u5728\u9996\u9875\uFF0Cprivate \u4F1A\u9ED8\u8BA4\u9690\u85CF").addDropdown(a=>{a.addOption("public","\u516C\u5F00 / public"),a.addOption("private","\u79C1\u5BC6 / private"),a.setValue(this.data.visibility).onChange(n=>{this.data.visibility=n})}),this.fileNamePreviewEl=t.createDiv({cls:"love-linker-muted"}),this.updateFileNamePreview();let e=t.createDiv({cls:"love-linker-row"}),s=e.createEl("button",{text:"\u521B\u5EFA\u6587\u6863"}),i=e.createEl("button",{text:"\u53D6\u6D88"});s.addEventListener("click",async()=>{await this.options.onSubmit(this.data)!==!1&&this.close()}),i.addEventListener("click",()=>this.close())}updateFileNamePreview(){this.fileNamePreviewEl&&this.fileNamePreviewEl.setText(`\u6587\u4EF6\u540D\u9884\u89C8\uFF1A${this.resolveFileName()}`)}resolveFileName(){let t=this.data.fileName.trim()||this.defaultFileNameBase;return t.endsWith(`.${this.options.defaultExtension}`)||t.includes(".")?t:`${t}.${this.options.defaultExtension}`}buildDefaultFileNameBase(t){return`${R(t)?t:V(new Date)}-${O("milestone")}`}},Q=class extends g.Modal{constructor(t,e){super(t);this.options=e;this.resolved=!1;this.values={};e.changes.forEach(s=>{this.values[s.key]=s.value})}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u8865\u5168/\u4FEE\u590D frontmatter"}),t.createEl("p",{text:"\u5C06\u5199\u5165\u4EE5\u4E0B\u5B57\u6BB5\uFF0C\u786E\u8BA4\u540E\u4F1A\u76F4\u63A5\u4FDD\u5B58\u5230\u5F53\u524D\u6587\u6863\u3002"});let e=t.createDiv({cls:"llp-repair-list"});this.options.changes.length===0&&e.createDiv({text:"\u5F53\u524D\u6587\u6863\u65E0\u9700\u4FEE\u590D\u3002",cls:"love-linker-muted"}),this.options.changes.forEach(n=>{let l=e.createDiv({cls:"llp-repair-row"});if(l.createDiv({text:n.label,cls:"llp-repair-label"}),n.editable){let d=l.createEl("textarea",{cls:"llp-repair-input"});d.value=n.value,d.rows=3,d.addEventListener("input",()=>{this.values[n.key]=d.value.trim()})}else l.createDiv({text:n.value||"\uFF08\u7A7A\uFF09",cls:"llp-repair-value"});n.note&&l.createDiv({text:n.note,cls:"love-linker-muted"})});let s=t.createDiv({cls:"love-linker-row"}),i=s.createEl("button",{text:"\u5E94\u7528\u4FEE\u590D"}),a=s.createEl("button",{text:"\u53D6\u6D88"});i.addEventListener("click",()=>this.resolve("confirm")),a.addEventListener("click",()=>this.resolve("cancel"))}onClose(){this.resolved||this.options.onResolve("cancel",this.values)}resolve(t){this.resolved=!0,this.options.onResolve(t,this.values),this.close()}},X=class extends g.Modal{constructor(t,e){super(t);this.options=e;this.forcePrivate=!1;this.manifestOnly=!1;this.useCustomFileName=!1;this.slugValue=e.defaultSlug,this.fileNameValue=`${e.defaultSlug}.${e.extension}`}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u8BBE\u7F6E\u6587\u7AE0 slug"});let e=t.createDiv({cls:"love-linker-muted"}),s=t.createDiv({cls:"love-linker-muted"}),i=()=>{let m=/^[a-z0-9-]+$/.test(this.slugValue);e.setText(m?"\u5EFA\u8BAE\u4EC5\u4F7F\u7528\u5C0F\u5199\u5B57\u6BCD / \u6570\u5B57 / \u77ED\u6A2A\u7EBF\u3002":"\u5F53\u524D slug \u5305\u542B\u7279\u6B8A\u5B57\u7B26\uFF0C\u53EF\u80FD\u5BFC\u81F4 URL \u4E0D\u53CB\u597D\u3002")},a=()=>{s.setText(`\u8FDC\u7AEF\u6587\u4EF6\u540D\u9884\u89C8\uFF1A${this.resolveFileName()}`)};new g.Setting(t).setName("Slug").setDesc("\u5C06\u7528\u4E8E\u7F51\u7AD9 URL").addText(m=>{m.setPlaceholder("\u4F8B\u5982\uFF1Afirst-trip").setValue(this.slugValue).onChange(f=>{this.slugValue=f.trim(),this.useCustomFileName||(this.fileNameValue=`${this.slugValue}.${this.options.extension}`),i(),a()})}),new g.Setting(t).setName("\u63A8\u9001\u4E3A private").setDesc("\u4F1A\u5199\u5165\u5F53\u524D\u6587\u4EF6 frontmatter \u7684 visibility").addToggle(m=>{m.setValue(this.forcePrivate).onChange(f=>{this.forcePrivate=f})}),new g.Setting(t).setName("\u9AD8\u7EA7\u9009\u9879").setDesc("\u53EF\u81EA\u5B9A\u4E49\u8FDC\u7AEF\u6587\u4EF6\u540D\u6216\u53EA\u66F4\u65B0 manifest").addToggle(m=>{m.setValue(!1).onChange(f=>{this.useCustomFileName=f,n.style.display=f?"block":"none",a()})});let n=t.createDiv({cls:"love-linker-section"});n.style.display="none",new g.Setting(n).setName("\u81EA\u5B9A\u4E49\u8FDC\u7AEF\u6587\u4EF6\u540D").setDesc("\u4F8B\u5982\uFF1Amy-post.md\uFF0C\u4E0D\u586B\u5219\u4F7F\u7528 slug").addText(m=>{m.setPlaceholder(`${this.slugValue}.${this.options.extension}`).setValue(this.fileNameValue).onChange(f=>{this.fileNameValue=f.trim(),a()})}),new g.Setting(n).setName("\u4EC5\u66F4\u65B0 manifest").setDesc("\u4E0D\u4E0A\u4F20\u5F53\u524D\u6587\u6863\uFF0C\u4EC5\u66F4\u65B0 slug -> file \u6620\u5C04").addToggle(m=>{m.setValue(this.manifestOnly).onChange(f=>{this.manifestOnly=f})}),i(),a();let l=t.createDiv({cls:"love-linker-row"}),d=l.createEl("button",{text:"\u7EE7\u7EED"}),h=l.createEl("button",{text:"\u53D6\u6D88"});d.addEventListener("click",()=>{if(!this.slugValue.trim()){new g.Notice("slug \u4E0D\u80FD\u4E3A\u7A7A\u3002",3e3);return}if(/[\\/]/.test(this.resolveFileName())){new g.Notice("\u6587\u4EF6\u540D\u4E0D\u80FD\u5305\u542B\u659C\u6760\u3002",3e3);return}this.options.onSubmit({slug:this.slugValue.trim(),fileName:this.resolveFileName(),forcePrivate:this.forcePrivate,manifestOnly:this.manifestOnly}),this.close()}),h.addEventListener("click",()=>this.close())}resolveFileName(){if(this.useCustomFileName&&this.fileNameValue.trim()){let t=this.fileNameValue.trim();return t.endsWith(`.${this.options.extension}`)||t.includes(".")?t:`${t}.${this.options.extension}`}return`${this.slugValue}.${this.options.extension}`}};var Z=class extends g.Modal{constructor(t,e){super(t);this.options=e;this.resolved=!1}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Slug \u5DF2\u5B58\u5728"}),t.createEl("p",{text:`\u8FDC\u7AEF\u5DF2\u5B58\u5728 slug: ${this.options.slug}\uFF08\u6587\u4EF6\uFF1A${this.options.existingFile}\uFF09\u3002\u8BF7\u9009\u62E9\u5904\u7406\u65B9\u5F0F\u3002`});let e=t.createDiv({cls:"love-linker-row"}),s=e.createEl("button",{text:"\u8986\u76D6"}),i=e.createEl("button",{text:"\u6539 slug"}),a=e.createEl("button",{text:"\u53D6\u6D88"});s.addEventListener("click",()=>this.resolve("overwrite")),i.addEventListener("click",()=>this.resolve("change")),a.addEventListener("click",()=>this.resolve("cancel"))}onClose(){this.resolved||this.options.onResolve("cancel")}resolve(t){this.resolved=!0,this.options.onResolve(t),this.close()}},tt=class extends g.Modal{constructor(t,e){var s;super(t);this.options=e;this.selected=(s=e.current)!=null?s:""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u9009\u62E9\u6587\u7AE0\u4E3B\u8272 (accent)"}),t.createEl("p",{text:this.selected?`\u5F53\u524D\uFF1A${this.selected}`:"\u5F53\u524D\u672A\u8BBE\u7F6E accent\u3002"}),new g.Setting(t).setName("Accent").setDesc("\u6765\u81EA love-linker \u8C03\u8272\u677F\uFF0C\u53EF\u5728\u8BBE\u7F6E\u4E2D\u6269\u5C55").addDropdown(a=>{var d;let n=this.options.options,l=n.map(h=>h.value);this.selected&&!l.includes(this.selected)&&a.addOption(this.selected,`${this.selected}\uFF08\u5F53\u524D\uFF09`),n.forEach(h=>a.addOption(h.value,h.label)),a.setValue(this.selected||((d=n[0])==null?void 0:d.value)||"").onChange(h=>{this.selected=h})});let e=t.createDiv({cls:"love-linker-row"}),s=e.createEl("button",{text:"\u4FDD\u5B58"}),i=e.createEl("button",{text:"\u53D6\u6D88"});s.addEventListener("click",()=>{this.options.onSubmit(this.selected),this.close()}),i.addEventListener("click",()=>this.close())}},et=class extends g.Modal{constructor(t,e){var s,i;super(t);this.options=e;this.resolved=!1;this.slugValue="";this.slugValue=(i=(s=e.defaultValue)==null?void 0:s.trim())!=null?i:""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:this.options.title}),t.createEl("p",{text:this.options.description}),new g.Setting(t).setName("Slug").setDesc("\u5C06\u7528\u4E8E\u5339\u914D\u8FDC\u7AEF manifest").addText(a=>{a.setPlaceholder("\u4F8B\u5982\uFF1Ahello-world").setValue(this.slugValue).onChange(n=>{this.slugValue=n.trim()})});let e=t.createDiv({cls:"love-linker-row"}),s=e.createEl("button",{text:"\u786E\u8BA4"}),i=e.createEl("button",{text:"\u53D6\u6D88"});s.addEventListener("click",()=>{if(!this.slugValue){new g.Notice("slug \u4E0D\u80FD\u4E3A\u7A7A\u3002",3e3);return}this.resolve(this.slugValue)}),i.addEventListener("click",()=>this.resolve(null))}onClose(){this.resolved||this.options.onSubmit(null)}resolve(t){this.resolved=!0,this.options.onSubmit(t),this.close()}},st=class extends g.Modal{constructor(t,e){super(t);this.options=e;this.resolved=!1;this.slugInputValue=""}onOpen(){let{contentEl:t}=this;t.empty(),this.options.mode==="delete"?(t.createEl("h2",{text:"\u5371\u9669\u64CD\u4F5C\uFF1A\u5F7B\u5E95\u5220\u9664\u8FDC\u7AEF\u6587\u7AE0\uFF1F"}),t.createEl("p",{text:"\u5C06\u4ECE manifest \u79FB\u9664\u5E76\u5C1D\u8BD5\u5220\u9664\u8FDC\u7AEF\u6587\u4EF6\uFF0C\u5220\u9664\u540E\u53EF\u80FD\u65E0\u6CD5\u6062\u590D\u3002"})):(t.createEl("h2",{text:"\u786E\u8BA4\u4E0B\u7EBF\u6587\u7AE0\uFF1F"}),t.createEl("p",{text:"\u4E0B\u7EBF\u540E\u6587\u7AE0\u5C06\u4ECE\u7F51\u7AD9\u7D22\u5F15\u4E2D\u79FB\u9664\uFF0CISR \u5468\u671F\u540E\u7F51\u7AD9\u65E0\u6CD5\u8BBF\u95EE\uFF0C\u4F46\u4E0D\u4F1A\u5220\u9664\u8FDC\u7AEF\u6587\u4EF6\u3002"}));let e=t.createEl("ul",{cls:"llp-list"});e.createEl("li",{text:`slug: ${this.options.slug}`}),e.createEl("li",{text:`file: ${this.options.file}`}),e.createEl("li",{text:`\u8FDC\u7AEF\u8DEF\u5F84: ${this.options.remotePath}`}),this.options.mismatchNote&&t.createDiv({text:this.options.mismatchNote,cls:"llp-muted"}),this.options.mode==="delete"&&(t.createEl("p",{text:"\u8BF7\u8F93\u5165 slug \u4EE5\u786E\u8BA4\u5220\u9664\u64CD\u4F5C\u3002"}),new g.Setting(t).setName("\u786E\u8BA4 slug").setDesc("\u8F93\u5165\u4E0E\u4E0A\u65B9\u4E00\u81F4\u7684 slug \u624D\u80FD\u7EE7\u7EED").addText(a=>{a.setPlaceholder(this.options.slug).setValue("").onChange(n=>{this.slugInputValue=n.trim(),this.updateConfirmState()})}));let s=t.createDiv({cls:"love-linker-row"});this.confirmButton=s.createEl("button",{text:this.options.mode==="delete"?"\u786E\u8BA4\u5220\u9664":"\u786E\u8BA4\u4E0B\u7EBF"});let i=s.createEl("button",{text:"\u53D6\u6D88"});this.options.mode==="delete"&&(this.confirmButton.addClass("llp-button"),this.confirmButton.addClass("llp-button--danger"),this.confirmButton.disabled=!0),this.confirmButton.addEventListener("click",()=>this.resolve("confirm")),i.addEventListener("click",()=>this.resolve("cancel"))}onClose(){this.resolved||this.options.onResolve("cancel")}updateConfirmState(){this.confirmButton&&(this.confirmButton.disabled=this.slugInputValue!==this.options.slug)}resolve(t){this.resolved=!0,this.options.onResolve(t),this.close()}};var x=require("obsidian");var U="love-linker-publish-panel",bt=[{id:"validate",label:"\u6821\u9A8C\u6587\u6863"},{id:"manifest",label:"\u62C9\u53D6 manifest"},{id:"upload",label:"\u4E0A\u4F20\u6587\u6863"},{id:"update",label:"\u66F4\u65B0 manifest"},{id:"delete",label:"\u5220\u9664/\u79FB\u52A8\u6587\u4EF6"}],it=class extends x.ItemView{constructor(t,e){super(t);this.plugin=e;this.stepRefs={};this.manifestItems=[];this.remoteStatus={status:"unknown"};this.formState={title:"",date:"",place:"",visibility:"public",accent:"",cover:"",tags:"",excerpt:""};this.formEls={};this.formDirty=!1;this.lastFormFilePath="";this.currentSlug="";this.hasActiveFile=!1;this.actionBusy=!1}getViewType(){return U}getDisplayText(){return"Love Linker \u53D1\u5E03\u9762\u677F"}getIcon(){return"paper-plane"}async onOpen(){this.render()}onClose(){this.refreshTimer&&(window.clearTimeout(this.refreshTimer),this.refreshTimer=void 0),this.contentEl.empty()}render(){let{contentEl:t}=this;t.empty(),t.addClass("llp-panel");let e=t.createDiv({cls:"llp-header"});e.createEl("h2",{text:"Love Linker \u53D1\u5E03"});let s=e.createDiv({cls:"llp-header-actions"});s.createEl("button",{text:"\u5237\u65B0"}).addEventListener("click",()=>{this.refresh(),this.loadManifestPreview()}),s.createEl("button",{text:"\u8BBE\u7F6E"}).addEventListener("click",()=>{this.plugin.openSettings()}),this.headerStatusEl=t.createDiv({cls:"llp-header-sub"});let i=t.createDiv({cls:"llp-card"});i.createEl("h3",{text:"\u5F53\u524D\u6587\u7AE0"});let a=i.createDiv({cls:"llp-row"});this.fileInfoEl=a.createDiv({cls:"llp-file"}),this.validationBadgeEl=a.createSpan({cls:"llp-badge"}),this.validationDetailEl=i.createDiv({cls:"llp-muted"}),this.validationListEl=i.createEl("ul",{cls:"llp-list"});let n=i.createDiv({cls:"llp-actions"});this.pushButton=n.createEl("button",{text:"\u63A8\u9001/\u66F4\u65B0",cls:"llp-button llp-button--primary"}),this.newButton=n.createEl("button",{text:"\u65B0\u5EFA\u6587\u7AE0",cls:"llp-button"}),this.repairButton=n.createEl("button",{text:"\u8865\u5168/\u4FEE\u590D\u5C5E\u6027",cls:"llp-button llp-button--ghost"}),this.accentButton=n.createEl("button",{text:"\u4FEE\u6539 accent",cls:"llp-button llp-button--ghost"}),this.unpublishButton=n.createEl("button",{text:"\u4E0B\u7EBF",cls:"llp-button llp-button--warn"}),this.deleteButton=n.createEl("button",{text:"\u5F7B\u5E95\u5220\u9664",cls:"llp-button llp-button--danger"}),this.pushButton.addEventListener("click",()=>{this.plugin.pushCurrentFile({progress:c=>this.setStatusMessage(c)})}),this.newButton.addEventListener("click",()=>this.plugin.openNewArticleModal()),this.repairButton.addEventListener("click",()=>this.plugin.repairCurrentFrontmatterWithPrompt()),this.accentButton.addEventListener("click",()=>this.plugin.openAccentModal()),this.unpublishButton.addEventListener("click",()=>{this.plugin.unpublishCurrentFile({deleteRemote:!1})}),this.deleteButton.addEventListener("click",()=>{this.plugin.unpublishCurrentFile({deleteRemote:!0})});let l=t.createDiv({cls:"llp-card"});l.createEl("h3",{text:"\u8FDC\u7AEF WebDAV"});let d=l.createDiv({cls:"llp-row"});this.remoteStatusBadgeEl=d.createSpan({cls:"llp-badge"}),this.remoteInfoEl=l.createDiv({cls:"llp-muted"});let h=l.createDiv({cls:"llp-actions"});h.createEl("button",{text:"\u6D4B\u8BD5\u8FDE\u63A5",cls:"llp-button"}).addEventListener("click",async()=>{let c=await this.plugin.testConnection({silent:!0});this.setRemoteStatusFromCheck(c)}),h.createEl("button",{text:"\u8BFB\u53D6 manifest",cls:"llp-button"}).addEventListener("click",()=>{this.loadManifestPreview()}),this.manifestStatusEl=l.createDiv({cls:"llp-muted"});let m=l.createDiv({cls:"llp-row"});this.manifestFilterEl=m.createEl("input",{type:"text",cls:"llp-input",placeholder:"\u641C\u7D22 slug..."}),this.manifestFilterEl.addEventListener("input",()=>this.renderManifestList()),this.manifestListEl=l.createEl("ul",{cls:"llp-manifest-list"}),this.manifestNoteEl=l.createDiv({cls:"llp-muted"});let f=t.createDiv({cls:"llp-card"});f.createEl("h3",{text:"\u63A8\u9001\u8FDB\u5EA6"}),this.statusMessageEl=f.createDiv({cls:"llp-muted"});let b=f.createDiv({cls:"llp-stepper"});bt.forEach(c=>{let p=b.createDiv({cls:"llp-step"}),F=p.createDiv({cls:"llp-step-header"});F.createSpan({cls:"llp-step-dot"}),F.createDiv({text:c.label,cls:"llp-step-title"});let C=p.createDiv({cls:"llp-step-detail"});this.stepRefs[c.id]={itemEl:p,detailEl:C}});let S=t.createDiv({cls:"llp-card"});S.createEl("h3",{text:"\u6587\u7AE0\u5C5E\u6027\u5FEB\u6377\u7F16\u8F91"});let w=S.createDiv({cls:"llp-form"});new x.Setting(w).setName("title").setDesc("\u9875\u9762\u6807\u9898").addText(c=>{this.formEls.title=c.inputEl,c.onChange(p=>this.updateFormState("title",p))}),new x.Setting(w).setName("date").setDesc("\u683C\u5F0F YYYY-MM-DD").addText(c=>{this.formEls.date=c.inputEl,c.inputEl.type="date",c.onChange(p=>this.updateFormState("date",p))}),new x.Setting(w).setName("place").setDesc("\u53EF\u7559\u7A7A").addText(c=>{this.formEls.place=c.inputEl,c.onChange(p=>this.updateFormState("place",p))}),new x.Setting(w).setName("visibility").setDesc("public \u5C06\u51FA\u73B0\u5728\u9996\u9875").addDropdown(c=>{this.formEls.visibility=c.selectEl,c.addOption("public","public"),c.addOption("private","private"),c.onChange(p=>{this.updateFormState("visibility",p)})}),new x.Setting(w).setName("accent").setDesc("\u4E3B\u8272\uFF0C\u6765\u81EA\u8C03\u8272\u677F").addDropdown(c=>{this.formEls.accent=c.selectEl,this.fillAccentOptions(c.selectEl),c.onChange(p=>this.updateFormState("accent",p))}),new x.Setting(w).setName("cover").setDesc("\u5916\u94FE\u56FE\u5E8A URL").addText(c=>{this.formEls.cover=c.inputEl,c.setPlaceholder("https://..."),c.onChange(p=>this.updateFormState("cover",p))}),new x.Setting(w).setName("tags").setDesc("\u9017\u53F7\u5206\u9694").addText(c=>{this.formEls.tags=c.inputEl,c.setPlaceholder("\u65C5\u9014, \u6F6E\u58F0"),c.onChange(p=>this.updateFormState("tags",p))}),new x.Setting(w).setName("excerpt").setDesc("\u9996\u9875\u5361\u7247\u6587\u6848").addTextArea(c=>{this.formEls.excerpt=c.inputEl,c.inputEl.rows=3,c.onChange(p=>this.updateFormState("excerpt",p))});let D=S.createDiv({cls:"llp-actions"});this.formSaveButton=D.createEl("button",{text:"\u4FDD\u5B58\u5230 frontmatter",cls:"llp-button llp-button--primary"}),this.formSaveButton.addEventListener("click",async()=>{let c=await this.plugin.getActiveFrontmatter();if(!c.file){new x.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Markdown \u6587\u4EF6\u3002",3e3);return}await this.plugin.updateFrontmatterFromForm(c.file,this.formState),this.formDirty=!1,new x.Notice("frontmatter \u5DF2\u4FDD\u5B58\u3002",3e3),this.refresh()}),this.resetPushProgress(),this.refresh()}scheduleRefresh(){this.refreshTimer&&window.clearTimeout(this.refreshTimer),this.refreshTimer=window.setTimeout(()=>{this.refresh()},250)}async refresh(){await this.refreshFileStatus(),await this.refreshPropertyForm(),this.refreshRemoteInfo()}async refreshFileStatus(){var a,n;if(!this.fileInfoEl||!this.validationBadgeEl||!this.validationDetailEl||!this.validationListEl)return;let t=await this.plugin.getActiveFileStatus(),e=this.app.vault.getName?this.app.vault.getName():"",s=(n=(a=t.file)==null?void 0:a.path)!=null?n:"";if(this.headerStatusEl){let l=s?`Vault: ${e} \xB7 \u6587\u4EF6: ${s}`:`Vault: ${e}`;this.headerStatusEl.setText(l)}if(this.validationBadgeEl.className="llp-badge",this.validationListEl.empty(),!t.file){this.hasActiveFile=!1,this.fileInfoEl.setText("\u672A\u6253\u5F00 Markdown \u6587\u4EF6"),this.validationBadgeEl.addClass("llp-badge--muted"),this.validationBadgeEl.setText("\u672A\u5C31\u7EEA"),this.validationDetailEl.setText("\u6253\u5F00\u6587\u4EF6\u540E\u53EF\u68C0\u67E5 frontmatter\u3002\u4E5F\u53EF\u70B9\u51FB\u8865\u5168/\u4FEE\u590D\u5C5E\u6027\u5FEB\u901F\u751F\u6210\u3002 "),this.toggleActionAvailability(!1),this.currentSlug="",this.updateManifestNote();return}this.hasActiveFile=!0,this.fileInfoEl.setText(`${t.file.path}`),this.toggleActionAvailability(!0),this.currentSlug=await this.plugin.getActiveSlugCandidate();let i=t.validation.isPrivate?"\u5F53\u524D\u4E3A private\u3002 ":"";if(!t.hasFrontmatter){this.validationBadgeEl.addClass("llp-badge--error"),this.validationBadgeEl.setText("\u7F3A\u5C11 frontmatter"),this.validationDetailEl.setText("\u8BF7\u5148\u521B\u5EFA YAML \u5757\uFF0C\u6216\u4F7F\u7528\u8865\u5168/\u4FEE\u590D\u5C5E\u6027\u6309\u94AE\u3002 "),this.addListItems(["\u672A\u68C0\u6D4B\u5230 frontmatter\u3002"]),this.updateManifestNote();return}if(t.validation.errors.length>0){this.validationBadgeEl.addClass("llp-badge--error"),this.validationBadgeEl.setText("\u6821\u9A8C\u5931\u8D25"),this.validationDetailEl.setText("\u8BF7\u4FEE\u590D\u4EE5\u4E0B\u95EE\u9898\u540E\u518D\u63A8\u9001\u3002 "),this.addListItems(t.validation.errors),this.updateManifestNote();return}if(t.validation.warnings.length>0){this.validationBadgeEl.addClass("llp-badge--warn"),this.validationBadgeEl.setText("\u6709\u63D0\u793A"),this.validationDetailEl.setText(`${i}\u53EF\u4EE5\u7EE7\u7EED\u63A8\u9001\uFF0C\u4F46\u5EFA\u8BAE\u67E5\u770B\u63D0\u793A\u3002 `),this.addListItems(t.validation.warnings),this.updateManifestNote();return}this.validationBadgeEl.addClass("llp-badge--success"),this.validationBadgeEl.setText("\u6821\u9A8C\u901A\u8FC7"),this.validationDetailEl.setText(`${i}\u6587\u6863\u5DF2\u5C31\u7EEA\uFF0C\u53EF\u76F4\u63A5\u63A8\u9001/\u66F4\u65B0\u3002 `),this.updateManifestNote()}refreshRemoteInfo(){if(!this.remoteInfoEl||!this.remoteStatusBadgeEl)return;let t=this.plugin.getRemoteInfo();if(!t.baseUrl||!this.plugin.hasWebdavConfig()){this.setRemoteStatus({status:"unconfigured",message:"\u672A\u914D\u7F6E WebDAV"}),this.remoteInfoEl.setText("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u586B\u5199 Base URL / \u7528\u6237\u540D / \u5BC6\u7801\u3002"),this.manifestStatusEl&&this.manifestStatusEl.setText("\u672A\u914D\u7F6E WebDAV\uFF0C\u65E0\u6CD5\u8BFB\u53D6 manifest\u3002"),this.togglePushButton(!1);return}this.remoteInfoEl.setText(`Base URL: ${t.baseUrl} \xB7 \u76EE\u5F55: ${t.contentDir}`),this.togglePushButton(!0),(this.remoteStatus.status==="unknown"||this.remoteStatus.status==="unconfigured")&&this.setRemoteStatus({status:"unknown",message:"\u672A\u68C0\u6D4B"})}setStatusMessage(t){this.statusMessageEl&&this.statusMessageEl.setText(t)}resetPushProgress(){bt.forEach(t=>{this.setStepStatus(t.id,"idle")}),this.setStatusMessage("\u7B49\u5F85\u64CD\u4F5C")}setStepStatus(t,e,s){let i=this.stepRefs[t];i&&(i.itemEl.classList.remove("is-running","is-success","is-error","is-skipped"),e==="running"&&i.itemEl.classList.add("is-running"),e==="success"&&i.itemEl.classList.add("is-success"),e==="error"&&i.itemEl.classList.add("is-error"),e==="skipped"&&i.itemEl.classList.add("is-skipped"),i.detailEl.setText(s!=null?s:""))}async loadManifestPreview(){if(!this.manifestListEl||!this.manifestStatusEl)return;this.manifestStatusEl.setText("\u6B63\u5728\u62C9\u53D6 manifest...");let t=await this.plugin.fetchManifestPreview({silent:!0});if(this.manifestItems=t.items.slice(0,t.limit),t.status==="manifest_missing"){this.setRemoteStatus({status:"manifest_missing",message:"manifest \u4E0D\u5B58\u5728"}),this.manifestStatusEl.setText("\u8FDC\u7AEF manifest.json \u4E0D\u5B58\u5728\uFF0C\u5C06\u5728\u9996\u6B21\u63A8\u9001\u65F6\u81EA\u52A8\u521B\u5EFA\u3002 "),this.renderManifestList();return}if(t.status==="error"){this.setRemoteStatus({status:"error",message:"\u8BFB\u53D6\u5931\u8D25"}),this.manifestStatusEl.setText("\u8BFB\u53D6\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8BBE\u7F6E\u4E0E\u7F51\u7EDC\u3002 "),this.renderManifestList();return}this.setRemoteStatus({status:"connected",message:"\u5DF2\u8FDE\u63A5"});let e=t.limit;this.manifestStatusEl.setText(`\u5DF2\u8BFB\u53D6\u524D ${Math.min(t.items.length,e)} \u6761\uFF1A`),this.renderManifestList()}renderManifestList(){var s,i;if(!this.manifestListEl)return;let t=(i=(s=this.manifestFilterEl)==null?void 0:s.value.trim().toLowerCase())!=null?i:"";this.manifestListEl.empty(),(t?this.manifestItems.filter(a=>a.slug.toLowerCase().includes(t)):this.manifestItems).forEach(a=>{var f;let n=(f=this.manifestListEl)==null?void 0:f.createEl("li",{cls:"llp-manifest-item"});n==null||n.createDiv({text:`${a.slug} \u2192 ${a.file}`,cls:"llp-manifest-text"});let l=n==null?void 0:n.createDiv({cls:"llp-manifest-actions"}),d=this.plugin.hasWebdavConfig(),h=l==null?void 0:l.createEl("button",{text:"\u4E0B\u7EBF",cls:"llp-button llp-button--warn llp-button--tiny"}),m=l==null?void 0:l.createEl("button",{text:"\u5220\u9664",cls:"llp-button llp-button--danger llp-button--tiny"});h&&(h.disabled=this.actionBusy||!d,h.addEventListener("click",()=>{this.plugin.unpublishBySlug(a.slug,{deleteRemote:!1,fileHint:a.file})})),m&&(m.disabled=this.actionBusy||!d,m.addEventListener("click",()=>{this.plugin.unpublishBySlug(a.slug,{deleteRemote:!0,fileHint:a.file})}))}),this.updateManifestNote()}updateManifestNote(){if(!this.manifestNoteEl)return;if(!this.currentSlug){this.manifestNoteEl.setText("\u5F53\u524D\u672A\u68C0\u6D4B\u5230 slug\u3002\u63A8\u9001\u65F6\u53EF\u8BBE\u7F6E\u3002 ");return}let t=this.manifestItems.some(e=>e.slug===this.currentSlug);this.manifestNoteEl.setText(t?"\u8FDC\u7AEF\u5DF2\u5B58\u5728\u8BE5 slug\uFF08\u5C06\u8986\u76D6/\u66F4\u65B0\uFF09\u3002":"\u8FDC\u7AEF\u672A\u627E\u5230\u8BE5 slug\uFF08\u5C06\u65B0\u589E\uFF09\u3002")}async refreshPropertyForm(){var i,a,n,l,d,h,m,f,b,S,w,D;let t=await this.plugin.getActiveFrontmatter();if(!t.file){this.applyFormState({title:"",date:V(new Date),place:"",visibility:"public",accent:(a=(i=this.plugin.getAccentOptions()[0])==null?void 0:i.value)!=null?a:"",cover:"",tags:"",excerpt:""},"");return}let e=Y((n=t.data)!=null?n:{}),s=Array.isArray((l=t.data)==null?void 0:l.tags)?((d=t.data)==null?void 0:d.tags).map(c=>String(c)).join(", "):typeof((h=t.data)==null?void 0:h.tags)=="string"?(m=t.data)==null?void 0:m.tags:"";this.applyFormState({title:e.title,date:e.date||V(new Date),place:(f=e.place)!=null?f:"",visibility:e.visibility==="private"?"private":"public",accent:(w=(S=e.accent)!=null?S:(b=this.plugin.getAccentOptions()[0])==null?void 0:b.value)!=null?w:"",cover:(D=e.cover)!=null?D:"",tags:s,excerpt:e.excerpt},t.file.path)}applyFormState(t,e){if(!(this.formDirty&&e===this.lastFormFilePath)&&(this.formState={...t},this.lastFormFilePath=e,this.formDirty=!1,this.formEls.title&&(this.formEls.title.value=t.title),this.formEls.date&&(this.formEls.date.value=t.date),this.formEls.place&&(this.formEls.place.value=t.place),this.formEls.cover&&(this.formEls.cover.value=t.cover),this.formEls.tags&&(this.formEls.tags.value=t.tags),this.formEls.excerpt&&(this.formEls.excerpt.value=t.excerpt),this.formEls.visibility&&(this.formEls.visibility.value=t.visibility),this.formEls.accent)){let s=this.formEls.accent;if(t.accent&&!Array.from(s.options).some(i=>i.value===t.accent)){let i=document.createElement("option");i.value=t.accent,i.text=`${t.accent}\uFF08\u5F53\u524D\uFF09`,s.appendChild(i)}s.value=t.accent||s.value}}updateFormState(t,e){this.formState={...this.formState,[t]:e},this.formDirty=!0}fillAccentOptions(t){let e=this.plugin.getAccentOptions();t.innerHTML="",e.forEach(s=>{let i=document.createElement("option");i.value=s.value,i.text=s.label,t.appendChild(i)})}setRemoteStatus(t){var s;if(this.remoteStatus=t,!this.remoteStatusBadgeEl)return;this.remoteStatusBadgeEl.className="llp-badge";let{status:e}=t;if(e==="connected"){this.remoteStatusBadgeEl.addClass("llp-badge--success"),this.remoteStatusBadgeEl.setText("\u5DF2\u8FDE\u63A5");return}if(e==="manifest_missing"){this.remoteStatusBadgeEl.addClass("llp-badge--warn"),this.remoteStatusBadgeEl.setText("manifest \u4E0D\u5B58\u5728");return}if(e==="auth_failed"){this.remoteStatusBadgeEl.addClass("llp-badge--error"),this.remoteStatusBadgeEl.setText("\u9274\u6743\u5931\u8D25");return}if(e==="unconfigured"){this.remoteStatusBadgeEl.addClass("llp-badge--muted"),this.remoteStatusBadgeEl.setText("\u672A\u914D\u7F6E");return}if(e==="error"){this.remoteStatusBadgeEl.addClass("llp-badge--error"),this.remoteStatusBadgeEl.setText("\u8FDE\u63A5\u5F02\u5E38");return}this.remoteStatusBadgeEl.addClass("llp-badge--muted"),this.remoteStatusBadgeEl.setText((s=t.message)!=null?s:"\u672A\u68C0\u6D4B")}setRemoteStatusFromCheck(t){if(t.status==="unconfigured"){this.setRemoteStatus({status:"unconfigured",message:t.message});return}if(t.status==="manifest_missing"){this.setRemoteStatus({status:"manifest_missing",message:t.message});return}if(t.status==="auth_failed"){this.setRemoteStatus({status:"auth_failed",message:t.message});return}if(t.status==="ok"){this.setRemoteStatus({status:"connected",message:t.message});return}this.setRemoteStatus({status:"error",message:t.message})}addListItems(t){this.validationListEl&&t.forEach(e=>{var i;let s=(i=this.validationListEl)==null?void 0:i.createEl("li");s==null||s.setText(e)})}toggleActionAvailability(t){this.pushButton&&(this.pushButton.disabled=!t),this.repairButton&&(this.repairButton.disabled=!t),this.accentButton&&(this.accentButton.disabled=!t),this.formSaveButton&&(this.formSaveButton.disabled=!t);let e=t&&this.plugin.hasWebdavConfig();this.unpublishButton&&(this.unpublishButton.disabled=!e||this.actionBusy),this.deleteButton&&(this.deleteButton.disabled=!e||this.actionBusy)}togglePushButton(t){this.pushButton&&(this.pushButton.disabled=!t||!this.hasActiveFile||!this.plugin.hasWebdavConfig())}setActionBusy(t){this.actionBusy=t;let e=this.hasActiveFile&&this.plugin.hasWebdavConfig();this.unpublishButton&&(this.unpublishButton.disabled=t||!e),this.deleteButton&&(this.deleteButton.disabled=t||!e),this.renderManifestList()}};var Et=require("obsidian"),v=class extends Error{constructor(o,t){super(o),this.name="WebDavError",this.status=t}},Bt=r=>r.trim().replace(/\/+$/,""),Lt=r=>r.trim().replace(/^\/+|\/+$/g,""),Mt=r=>r.split("/").map(o=>encodeURIComponent(o)).join("/"),St=r=>{if(typeof TextEncoder!="undefined")return new TextEncoder().encode(r);let o=encodeURIComponent(r),t=[];for(let e=0;e<o.length;e+=1){let s=o[e];if(s==="%"){let i=o.slice(e+1,e+3);t.push(parseInt(i,16)),e+=2}else t.push(s.charCodeAt(0))}return new Uint8Array(t)},Pt=r=>{if(typeof btoa=="function")return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(s,i)=>String.fromCharCode(parseInt(i,16))));let o=St(r),t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e="";for(let s=0;s<o.length;s+=3){let i=o[s],a=s+1<o.length?o[s+1]:0,n=s+2<o.length?o[s+2]:0,l=i<<16|a<<8|n;e+=t[l>>18&63],e+=t[l>>12&63],e+=s+1<o.length?t[l>>6&63]:"=",e+=s+2<o.length?t[l&63]:"="}return e},Nt=1e4,at=class{constructor(o){this.getSettings=o}buildUrl(o){let t=this.getSettings(),e=Bt(t.webdavBaseUrl);if(!e)throw new v("\u672A\u914D\u7F6E WEBDAV_BASE_URL\u3002\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u586B\u5199\u3002",0);let s=o.map(i=>Lt(i)).filter(Boolean).map(Mt).join("/");return`${e}/${s}`}getAuthHeader(){let o=this.getSettings();if(!o.webdavUsername||!o.webdavPassword)throw new v("\u672A\u914D\u7F6E WEBDAV_USERNAME \u6216 WEBDAV_PASSWORD\u3002",0);return`Basic ${Pt(`${o.webdavUsername}:${o.webdavPassword}`)}`}async request(o){let t=null,e=new Promise((s,i)=>{t=setTimeout(()=>{i(new v("\u8BF7\u6C42\u8D85\u65F6\u3002",408))},Nt)});try{return await Promise.race([(0,Et.requestUrl)({...o,throw:!1}),e])}finally{t&&clearTimeout(t)}}async getText(o){let t=this.buildUrl(o),e=await this.request({url:t,method:"GET",headers:{Authorization:this.getAuthHeader()}});if(e.status<200||e.status>=300)throw new v(`WebDAV \u8BF7\u6C42\u5931\u8D25 (${e.status})`,e.status);return e.text}async getJson(o){let t=await this.getText(o);try{return JSON.parse(t)}catch(e){throw new v("\u8FDC\u7AEF\u8FD4\u56DE\u7684 JSON \u89E3\u6790\u5931\u8D25\u3002",0)}}async checkConnection(){let o=this.buildUrl([]),t=await this.request({url:o,method:"PROPFIND",headers:{Authorization:this.getAuthHeader(),Depth:"0"}});if(t.status<200||t.status>=300)throw new v(`WebDAV \u8FDE\u63A5\u5931\u8D25 (${t.status})`,t.status)}async ensureDirectory(o){let t=this.buildUrl(o),e=t.endsWith("/")?t:`${t}/`,s=this.getAuthHeader(),i=await this.request({url:e,method:"PROPFIND",headers:{Authorization:s,Depth:"0"}});if(i.status>=200&&i.status<300)return;let a=await this.request({url:e,method:"MKCOL",headers:{Authorization:s}});if(!(a.status>=200&&a.status<300)&&!(a.status===301||a.status===302||a.status===307||a.status===308||a.status===405))throw new v(`WebDAV \u76EE\u5F55\u521B\u5EFA\u5931\u8D25 (${a.status})`,a.status)}async putText(o,t,e){let s=this.buildUrl(o),i=St(t),a=i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength),n=await this.request({url:s,method:"PUT",body:a,headers:{Authorization:this.getAuthHeader(),"Content-Type":e}});if(n.status<200||n.status>=300)throw new v(`WebDAV \u4E0A\u4F20\u5931\u8D25 (${n.status})`,n.status)}async deleteFile(o){let t=this.buildUrl(o),e=await this.request({url:t,method:"DELETE",headers:{Authorization:this.getAuthHeader()}});if(e.status<200||e.status>=300)throw new v(`WebDAV \u5220\u9664\u5931\u8D25 (${e.status})`,e.status)}async move(o,t){let e=this.buildUrl(o),s=this.buildUrl(t),i=await this.request({url:e,method:"MOVE",headers:{Authorization:this.getAuthHeader(),Destination:s,Overwrite:"T"}});if(i.status<200||i.status>=300)throw new v(`WebDAV \u79FB\u52A8\u5931\u8D25 (${i.status})`,i.status)}};var nt=class extends u.Plugin{constructor(){super(...arguments);this.settings=ot}async onload(){await this.loadSettings(),this.webdav=new at(()=>this.settings),this.addSettingTab(new G(this.app,this)),this.registerView(U,t=>(this.publishView=new it(t,this),this.publishView)),this.addRibbonIcon("paper-plane","\u6253\u5F00 Love Linker \u53D1\u5E03\u9762\u677F",()=>{this.ensurePublishViewSingleInstance()}),this.addCommand({id:"love-linker-open-panel",name:"\u6253\u5F00\u53D1\u5E03\u9762\u677F",callback:()=>this.ensurePublishViewSingleInstance()}),this.addCommand({id:"love-linker-new-article",name:"\u65B0\u5EFA\u6587\u7AE0",callback:()=>this.openNewArticleModal()}),this.addCommand({id:"love-linker-push-current",name:"\u63A8\u9001/\u66F4\u65B0\u5F53\u524D\u6587\u6863\u5230 WebDAV",callback:()=>this.pushCurrentFile()}),this.addCommand({id:"love-linker-add-frontmatter",name:"\u8865\u5168/\u4FEE\u590D\u5F53\u524D\u6587\u6863\u5C5E\u6027",callback:()=>this.repairCurrentFrontmatterWithPrompt()}),this.addCommand({id:"love-linker-update-accent",name:"\u4FEE\u6539\u5F53\u524D\u6587\u6863 accent",callback:()=>this.openAccentModal()}),this.addCommand({id:"love-linker-unpublish-current",name:"\u4E0B\u7EBF\u5F53\u524D\u6587\u7AE0\uFF08\u4EC5\u79FB\u9664 manifest\uFF09",callback:()=>this.unpublishCurrentFile({deleteRemote:!1})}),this.addCommand({id:"love-linker-delete-current",name:"\u5F7B\u5E95\u5220\u9664\u5F53\u524D\u6587\u7AE0\uFF08\u79FB\u9664 manifest + \u5220\u9664\u8FDC\u7AEF\u6587\u4EF6\uFF09",callback:()=>this.unpublishCurrentFile({deleteRemote:!0})}),this.app.workspace.onLayoutReady(()=>{this.settings.autoOpenPanel&&this.ensurePublishViewSingleInstance({reveal:!1})}),this.registerEvent(this.app.workspace.on("file-menu",(t,e)=>{e instanceof u.TFile&&this.isMarkdownFile(e)&&t.addItem(s=>{s.setTitle("\u63A8\u9001/\u66F4\u65B0\u5230 WebDAV").setIcon("paper-plane").onClick(()=>this.pushCurrentFile({file:e}))})})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{var t;(t=this.publishView)==null||t.scheduleRefresh()})),this.registerEvent(this.app.workspace.on("file-open",()=>{var t;(t=this.publishView)==null||t.scheduleRefresh()})),this.registerEvent(this.app.metadataCache.on("changed",t=>{var s;let e=this.app.workspace.getActiveFile();e&&t.path===e.path&&((s=this.publishView)==null||s.scheduleRefresh())}))}onunload(){this.app.workspace.detachLeavesOfType(U)}async loadSettings(){this.settings=Object.assign({},ot,await this.loadData()),this.settings.defaultExtension!=="md"&&(this.settings.defaultExtension="md"),this.settings.defaultCoverUrl==="https://your-image-host/cover.svg"&&(this.settings.defaultCoverUrl=""),this.settings.webdavTrashDir.trim()||(this.settings.webdavTrashDir="_trash")}async saveSettings(){var t;await this.saveData(this.settings),(t=this.publishView)==null||t.refreshRemoteInfo()}getRemoteInfo(){return{baseUrl:this.settings.webdavBaseUrl.trim(),contentDir:this.settings.webdavContentDir.trim()||"milestones"}}hasWebdavConfig(){return!!(this.settings.webdavBaseUrl.trim()&&this.settings.webdavUsername.trim()&&this.settings.webdavPassword.trim())}async ensurePublishViewSingleInstance(t){var i,a;let e=this.app.workspace.getLeavesOfType(U),s=e[0];if(e.length>1&&e.slice(1).forEach(n=>n.detach()),s||(s=(i=this.app.workspace.getRightLeaf(!1))!=null?i:this.app.workspace.getRightLeaf(!0)),!s){new u.Notice("\u65E0\u6CD5\u6253\u5F00\u4FA7\u8FB9\u680F\uFF0C\u8BF7\u68C0\u67E5\u5DE5\u4F5C\u533A\u5E03\u5C40\u3002",3e3);return}await s.setViewState({type:U,active:!0}),(t==null?void 0:t.reveal)!==!1&&this.app.workspace.revealLeaf(s),this.publishView=s.view,(a=this.publishView)==null||a.refresh()}openSettings(){var e,s,i,a;let t=this.app;(s=(e=t.setting)==null?void 0:e.open)==null||s.call(e),(a=(i=t.setting)==null?void 0:i.openTabById)==null||a.call(i,"love-linker-publisher")}getAccentOptions(){let t=[];for(let s of this.settings.accentOptions){let i=s.trim();if(!i)continue;let[a,n]=i.split("|").map(l=>l.trim());a&&t.push({value:a,label:n||a})}return t.length===0&&t.push({value:this.settings.defaultAccent,label:this.settings.defaultAccent}),!t.some(s=>s.value===this.settings.defaultAccent)&&this.settings.defaultAccent.trim()&&t.unshift({value:this.settings.defaultAccent,label:`${this.settings.defaultAccent}\uFF08\u9ED8\u8BA4\uFF09`}),t}async openNewArticleModal(){new K(this.app,{accentOptions:this.getAccentOptions(),defaultAccent:this.settings.defaultAccent,defaultCover:this.settings.defaultCoverUrl,defaultExtension:this.settings.defaultExtension,onSubmit:async e=>this.createNewArticle(e)}).open()}async createNewArticle(t){var m;let e=this.settings.localContentFolder.trim()||"milestones",s=R(t.date)?t.date:V(new Date),i=this.resolveNewFileName(t.fileName,s);if(!i)return!1;let a=(0,u.normalizePath)(`${e}/${i}`);if(this.app.vault.getAbstractFileByPath(a))return new u.Notice("\u6587\u4EF6\u5DF2\u5B58\u5728\uFF0C\u8BF7\u4FEE\u6539\u6587\u4EF6\u540D\u3002",4e3),!1;await this.ensureFolder(e);let n=gt({title:t.title,date:s,place:t.place,accent:t.accent,cover:t.cover||this.settings.defaultCoverUrl,excerpt:t.excerpt,tags:t.tags,visibility:t.visibility}),l=await this.app.vault.create(a,n),d=this.app.workspace.getLeaf(!0);await d.openFile(l,{active:!0});let h=d.view instanceof u.MarkdownView?d.view:null;if(h){let f=wt(n),b=f>=0?f+1:0;h.editor.setCursor({line:b,ch:0}),h.editor.focus()}return new u.Notice("\u5DF2\u521B\u5EFA\u65B0\u6587\u6863\u3002",3e3),(m=this.publishView)==null||m.refreshFileStatus(),!0}async pushCurrentFile(t){var D,c,p,F,C,T,B,L,M,P,W,H,_,$,k,z,j,rt,q,J,y,pt,dt;let e=(D=t==null?void 0:t.progress)!=null?D:()=>{},s=A=>{var mt;e(A),(mt=this.publishView)==null||mt.setStatusMessage(A)},i=(c=t==null?void 0:t.file)!=null?c:this.app.workspace.getActiveFile();if((p=this.publishView)==null||p.resetPushProgress(),(F=this.publishView)==null||F.setStepStatus("delete","skipped","\u63A8\u9001\u4E0D\u6D89\u53CA\u5220\u9664"),!i||!this.isMarkdownFile(i)){new u.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Markdown \u6587\u4EF6\u3002",3e3),(C=this.publishView)==null||C.setStepStatus("validate","error","\u672A\u6253\u5F00 Markdown \u6587\u4EF6");return}(T=this.publishView)==null||T.setStepStatus("validate","running","\u6B63\u5728\u89E3\u6790 frontmatter..."),s("\u6B63\u5728\u89E3\u6790 frontmatter..."),await this.saveFileIfOpen(i);let a=await this.app.vault.read(i),n=await this.readFrontmatter(i,a);if(!n.hasFrontmatter){new u.Notice("\u672A\u68C0\u6D4B\u5230 frontmatter\uFF0C\u8BF7\u5148\u521B\u5EFA YAML \u5757\u3002",4e3),(B=this.publishView)==null||B.setStepStatus("validate","error","\u672A\u68C0\u6D4B\u5230 frontmatter"),s("frontmatter \u7F3A\u5931");return}if(n.error||!n.data){new u.Notice("frontmatter \u89E3\u6790\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5 YAML \u683C\u5F0F\u3002",4e3),(L=this.publishView)==null||L.setStepStatus("validate","error","YAML \u89E3\u6790\u5931\u8D25"),s("frontmatter \u89E3\u6790\u5931\u8D25");return}let l=ht(n.data,this.getAccentOptions());if(!l.ok){new u.Notice(`\u6821\u9A8C\u5931\u8D25\uFF1A${l.errors.join("\uFF1B")}`,5e3),(M=this.publishView)==null||M.setStepStatus("validate","error",l.errors.join("\uFF1B")),s("\u6821\u9A8C\u5931\u8D25");return}(P=this.publishView)==null||P.setStepStatus("validate","success"),l.warnings.length>0&&new u.Notice(`\u63D0\u793A\uFF1A${l.warnings.join("\uFF1B")}`,4e3),l.isPrivate&&new u.Notice("\u8BE5\u6587\u7AE0\u4E3A private\uFF0C\u7F51\u7AD9\u53EF\u80FD\u4E0D\u4F1A\u751F\u6210\u6216\u51FA\u73B0\u5728\u9996\u9875\u3002",5e3);let d="md",h=await this.promptSlug(this.suggestSlug(i,n.data),d);if(!h)return;if(h.forcePrivate&&(s("\u6B63\u5728\u66F4\u65B0 visibility \u4E3A private..."),await this.updateVisibility(i,"private"),await this.saveFileIfOpen(i)),(W=this.publishView)==null||W.setStepStatus("manifest","running","\u6B63\u5728\u786E\u8BA4\u8FDC\u7AEF\u76EE\u5F55..."),s("\u6B63\u5728\u786E\u8BA4\u8FDC\u7AEF\u76EE\u5F55..."),!await this.ensureRemoteContentDir()){(H=this.publishView)==null||H.setStepStatus("manifest","error","\u8FDC\u7AEF\u76EE\u5F55\u521B\u5EFA\u5931\u8D25"),s("\u8FDC\u7AEF\u76EE\u5F55\u521B\u5EFA\u5931\u8D25");return}(_=this.publishView)==null||_.setStepStatus("manifest","running","\u6B63\u5728\u62C9\u53D6 manifest..."),s("\u6B63\u5728\u62C9\u53D6 manifest...");let f=await this.fetchManifest();if(!f){($=this.publishView)==null||$.setStepStatus("manifest","error","\u8BFB\u53D6 manifest \u5931\u8D25"),s("\u8BFB\u53D6 manifest \u5931\u8D25");return}(k=this.publishView)==null||k.setStepStatus("manifest","success");let b=await this.applySlugToManifest(f.items,h,d);if(!b)return;h=b.slugResult;let S=JSON.stringify({items:b.items},null,2)+`
`,w=!1;if(h.manifestOnly)(q=this.publishView)==null||q.setStepStatus("upload","skipped","\u4EC5\u66F4\u65B0 manifest"),s("\u5DF2\u8DF3\u8FC7\u6587\u6863\u4E0A\u4F20\uFF08\u4EC5\u66F4\u65B0 manifest\uFF09");else{(z=this.publishView)==null||z.setStepStatus("upload","running","\u6B63\u5728\u4E0A\u4F20\u6587\u6863..."),s("\u6B63\u5728\u4E0A\u4F20\u6587\u6863...");try{let A=await this.app.vault.read(i);await this.webdav.putText([this.settings.webdavContentDir,h.fileName],A,"text/markdown; charset=utf-8"),w=!0,(j=this.publishView)==null||j.setStepStatus("upload","success"),new u.Notice("\u6587\u6863\u5DF2\u4E0A\u4F20\u3002",3e3)}catch(A){new u.Notice(this.formatWebDavError(A,"\u4E0A\u4F20\u6587\u6863"),5e3),(rt=this.publishView)==null||rt.setStepStatus("upload","error",this.formatWebDavError(A,"\u4E0A\u4F20\u6587\u6863")),s("\u4E0A\u4F20\u6587\u6863\u5931\u8D25");return}}(J=this.publishView)==null||J.setStepStatus("update","running","\u6B63\u5728\u66F4\u65B0 manifest..."),s("\u6B63\u5728\u66F4\u65B0 manifest...");try{await this.webdav.putText([this.settings.webdavContentDir,this.settings.webdavManifestFile],S,"application/json; charset=utf-8"),(y=this.publishView)==null||y.setStepStatus("update","success"),new u.Notice("manifest \u5DF2\u66F4\u65B0\uFF0C\u7F51\u7AD9\u5C06\u5728 ISR \u5468\u671F\u5185\u81EA\u52A8\u5237\u65B0\u3002",4e3)}catch(A){w?new u.Notice("\u8FDC\u7AEF manifest \u66F4\u65B0\u5931\u8D25\uFF0C\u7F51\u7AD9\u53EF\u80FD\u65E0\u6CD5\u8BBF\u95EE\u8BE5\u6587\u7AE0\u3002\u8BF7\u91CD\u8BD5\u6216\u624B\u52A8\u4FEE\u590D\u3002",6e3):new u.Notice(this.formatWebDavError(A,"\u66F4\u65B0 manifest"),5e3),(pt=this.publishView)==null||pt.setStepStatus("update","error",this.formatWebDavError(A,"\u66F4\u65B0 manifest")),s("\u66F4\u65B0 manifest \u5931\u8D25");return}s("\u6B63\u5728\u5199\u5165 slug..."),await this.updateSlug(i,h.slug),await this.saveFileIfOpen(i),s("\u63A8\u9001/\u66F4\u65B0\u5B8C\u6210"),(dt=this.publishView)==null||dt.loadManifestPreview()}async testConnection(t){if(!this.hasWebdavConfig()){let e="\u672A\u914D\u7F6E WebDAV\uFF0C\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u586B\u5199\u3002";return t!=null&&t.silent||new u.Notice(e,4e3),{ok:!1,status:"unconfigured",message:e}}try{await this.webdav.getText([this.settings.webdavContentDir,this.settings.webdavManifestFile]);let e="\u8FDE\u63A5\u6210\u529F\u3002";return t!=null&&t.silent||new u.Notice(e,3e3),{ok:!0,status:"ok",message:e}}catch(e){if(e instanceof v&&e.status===404){let i="\u8FDC\u7AEF manifest.json \u4E0D\u5B58\u5728\uFF0C\u53EF\u5728\u9996\u6B21\u63A8\u9001\u65F6\u81EA\u52A8\u521B\u5EFA\u3002";return t!=null&&t.silent||new u.Notice(i,4e3),{ok:!1,status:"manifest_missing",message:i,statusCode:404}}let s=this.formatWebDavError(e,"\u6D4B\u8BD5\u8FDE\u63A5");return t!=null&&t.silent||new u.Notice(s,5e3),{ok:!1,status:e instanceof v&&(e.status===401||e.status===403)?"auth_failed":"error",message:s,statusCode:e instanceof v?e.status:void 0}}}async fetchManifestPreview(t){try{let e=await this.webdav.getJson([this.settings.webdavContentDir,this.settings.webdavManifestFile]);return{items:this.normalizeManifestItems(e.items),limit:this.settings.manifestPreviewLimit,status:"ok"}}catch(e){if(e instanceof v&&e.status===404){let s="\u8FDC\u7AEF manifest.json \u4E0D\u5B58\u5728\uFF0C\u53EF\u5728\u9996\u6B21\u63A8\u9001\u65F6\u81EA\u52A8\u521B\u5EFA\u3002";return t!=null&&t.silent||new u.Notice(s,4e3),{items:[],limit:this.settings.manifestPreviewLimit,status:"manifest_missing"}}return t!=null&&t.silent||new u.Notice(this.formatWebDavError(e,"\u8BFB\u53D6 manifest"),5e3),{items:[],limit:this.settings.manifestPreviewLimit,status:"error"}}}async getActiveFileStatus(){let t=this.app.workspace.getActiveFile();if(!t||!this.isMarkdownFile(t))return{file:null,hasFrontmatter:!1,validation:{ok:!1,errors:[],warnings:[],isPrivate:!1}};let e=await this.readFrontmatter(t);if(!e.hasFrontmatter)return{file:t,hasFrontmatter:!1,validation:{ok:!1,errors:[],warnings:[],isPrivate:!1}};if(e.error||!e.data)return{file:t,hasFrontmatter:!0,validation:{ok:!1,errors:["frontmatter \u89E3\u6790\u5931\u8D25"],warnings:[],isPrivate:!1}};let s=ht(e.data,this.getAccentOptions());return{file:t,hasFrontmatter:!0,validation:s}}async getActiveFrontmatter(){var s;let t=this.app.workspace.getActiveFile();if(!t||!this.isMarkdownFile(t))return{file:null,data:null,hasFrontmatter:!1};let e=await this.readFrontmatter(t);return{file:t,data:(s=e.data)!=null?s:{},hasFrontmatter:e.hasFrontmatter}}async getActiveSlugCandidate(){let t=this.app.workspace.getActiveFile();if(!t||!this.isMarkdownFile(t))return"";let e=await this.readFrontmatter(t);return e.data?this.suggestSlug(t,e.data):""}async saveFileIfOpen(t){var s;let e=this.app.workspace.getActiveViewOfType(u.MarkdownView);((s=e==null?void 0:e.file)==null?void 0:s.path)===t.path&&await e.save()}async readFrontmatter(t,e){var n;let s=(n=this.app.metadataCache.getFileCache(t))==null?void 0:n.frontmatter;if(s&&Object.keys(s).length>0)return{data:s,hasFrontmatter:!0,error:null};let i=e!=null?e:await this.app.vault.read(t),a=vt(i);return{data:a.data,hasFrontmatter:a.hasFrontmatter,error:a.error}}async ensureFolder(t){let e=(0,u.normalizePath)(t);this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}isMarkdownFile(t){return t.extension.toLowerCase()==="md"}suggestSlug(t,e){let s=e.slug?String(e.slug).trim():"";if(s)return s;let i=ct(t.basename);if(i&&i!==t.basename)return O(i);let a=e.title?String(e.title):"";return O(a||i)}suggestUnpublishSlug(t,e){let s=e.slug?String(e.slug).trim():"";if(s)return s;let i=ct(t.basename);if(i&&i!==t.basename)return O(i);let a=e.title?String(e.title):"";return a?O(a):""}async promptSlug(t,e){return await new Promise(s=>{let i=!1,a=new X(this.app,{defaultSlug:t,extension:e,onSubmit:n=>{i=!0,s(n)}});a.onClose=()=>{i||s(null)},a.open()})}async promptSlugInput(t){return await new Promise(e=>{let s=!1,i=new et(this.app,{title:"\u8F93\u5165 slug",description:"\u672A\u68C0\u6D4B\u5230\u5F53\u524D\u6587\u6863 slug\uFF0C\u8BF7\u8F93\u5165\u8981\u4E0B\u7EBF/\u5220\u9664\u7684 slug\u3002",defaultValue:t,onSubmit:a=>{s=!0,e(a)}});i.onClose=()=>{s||e(null)},i.open()})}async promptUnpublishConfirm(t){return await new Promise(e=>{new st(this.app,{...t,onResolve:e}).open()})}async promptConflict(t,e){return await new Promise(s=>{new Z(this.app,{slug:t,existingFile:e,onResolve:s}).open()})}async fetchManifest(){try{let t=await this.webdav.getJson([this.settings.webdavContentDir,this.settings.webdavManifestFile]);return{items:this.normalizeManifestItems(t.items)}}catch(t){return t instanceof v&&t.status===404?(new u.Notice("\u672A\u627E\u5230 manifest.json\uFF0C\u5C06\u5728\u9996\u6B21\u63A8\u9001\u65F6\u81EA\u52A8\u521B\u5EFA\u3002",4e3),{items:[]}):(new u.Notice(this.formatWebDavError(t,"\u8BFB\u53D6 manifest"),5e3),null)}}async fetchManifestForUnpublish(){try{let t=await this.webdav.getJson([this.settings.webdavContentDir,this.settings.webdavManifestFile]);return{items:this.normalizeManifestItems(t.items)}}catch(t){return t instanceof v&&t.status===404?(new u.Notice("\u672A\u627E\u5230 manifest.json\uFF0C\u65E0\u6CD5\u4E0B\u7EBF/\u5220\u9664\u3002",4e3),null):(new u.Notice(this.formatWebDavError(t,"\u8BFB\u53D6 manifest"),5e3),null)}}normalizeManifestItems(t){return Array.isArray(t)?t.map(e=>{var s,i;return{...e,slug:String((s=e.slug)!=null?s:"").trim(),file:String((i=e.file)!=null?i:"").trim()}}).filter(e=>e.slug&&e.file).sort((e,s)=>e.slug.localeCompare(s.slug)):[]}async applySlugToManifest(t,e,s){let i=e,a=[...t];for(;;){let l=a.find(h=>h.slug===i.slug);if(!l)break;let d=await this.promptConflict(i.slug,l.file);if(d==="cancel")return null;if(d==="change"){let h=await this.promptSlug(i.slug,s);if(!h)return null;i=h;continue}if(d==="overwrite"){l.file=i.fileName;break}}return a.some(l=>l.slug===i.slug)||a.push({slug:i.slug,file:i.fileName}),{items:this.normalizeManifestItems(a),slugResult:i}}async updateVisibility(t,e){await this.app.fileManager.processFrontMatter(t,s=>{s.visibility=e})}async updateSlug(t,e){await this.app.fileManager.processFrontMatter(t,s=>{s.slug=e})}async repairCurrentFrontmatterWithPrompt(){var S,w,D,c;let t=this.app.workspace.getActiveFile();if(!t||!this.isMarkdownFile(t)){new u.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Markdown \u6587\u4EF6\u3002",3e3);return}await this.saveFileIfOpen(t);let e=await this.app.vault.read(t),i=(S=(await this.readFrontmatter(t,e)).data)!=null?S:{},a=Y(i),n=[],l={},d=V(new Date);if(!a.title.trim()){let p=this.humanizeTitleFromFilename(t.basename);l.title=p,n.push({key:"title",label:"title",value:p})}let h=this.extractDateFromFilename(t.basename);if(!R(a.date)){let p=h!=null?h:d;l.date=p,n.push({key:"date",label:"date",value:p,note:a.date?`\u539F\u503C\uFF1A${a.date}`:"\u672A\u68C0\u6D4B\u5230\u65E5\u671F"})}if(!a.excerpt.trim()){let p=this.extractExcerptFromContent(e);l.excerpt=p,n.push({key:"excerpt",label:"excerpt",value:p,note:p?"\u6765\u81EA\u6B63\u6587\u9996\u6BB5\uFF08\u53EF\u7F16\u8F91\uFF09":"\u672A\u68C0\u6D4B\u5230\u6B63\u6587\uFF0C\u5C06\u7559\u7A7A",editable:!0})}if(!Array.isArray(i.tags))if(typeof i.tags=="string"){let p=I(i.tags);l.tags=p.join(", "),n.push({key:"tags",label:"tags",value:p.join(", "),note:"\u5DF2\u4ECE\u9017\u53F7\u5206\u9694\u6587\u672C\u8F6C\u6362\u4E3A\u6570\u7EC4"})}else i.tags==null&&(l.tags="",n.push({key:"tags",label:"tags",value:"",note:"\u672A\u8BBE\u7F6E\uFF0C\u5C06\u5199\u5165\u7A7A\u6570\u7EC4"}));let m=String((w=i.visibility)!=null?w:"").trim();if((!m||m!=="public"&&m!=="private")&&(l.visibility="public",n.push({key:"visibility",label:"visibility",value:"public",note:m?`\u539F\u503C\uFF1A${m}`:"\u672A\u8BBE\u7F6E"})),!String((D=i.accent)!=null?D:"").trim()){let p=this.settings.defaultAccent||((c=this.getAccentOptions()[0])==null?void 0:c.value)||"";l.accent=p,n.push({key:"accent",label:"accent",value:p||"\uFF08\u7A7A\uFF09",note:p?"\u4F7F\u7528\u9ED8\u8BA4 accent":"\u672A\u914D\u7F6E\u9ED8\u8BA4\u503C"})}if(n.length===0){new u.Notice("\u672A\u53D1\u73B0\u9700\u8981\u4FEE\u590D\u7684\u5B57\u6BB5\u3002",3e3);return}new Q(this.app,{changes:n,onResolve:async(p,F)=>{var C;p==="confirm"&&(await this.app.fileManager.processFrontMatter(t,T=>{var B,L,M,P;l.title!==void 0&&(T.title=(B=F.title)!=null?B:l.title),l.date!==void 0&&(T.date=(L=F.date)!=null?L:l.date),l.excerpt!==void 0&&(T.excerpt=(M=F.excerpt)!=null?M:l.excerpt),l.visibility!==void 0&&(T.visibility=l.visibility),l.accent!==void 0&&(T.accent=l.accent),l.tags!==void 0&&(T.tags=I((P=F.tags)!=null?P:l.tags))}),await this.saveFileIfOpen(t),new u.Notice("\u5DF2\u8865\u5168/\u4FEE\u590D frontmatter\u3002",3e3),(C=this.publishView)==null||C.refresh())}}).open()}async openAccentModal(t){var n;let e=t!=null?t:this.app.workspace.getActiveFile();if(!e||!this.isMarkdownFile(e)){new u.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Markdown \u6587\u4EF6\u3002",3e3);return}let s=await this.readFrontmatter(e),i=(n=s.data)!=null&&n.accent?String(s.data.accent).trim():"";new tt(this.app,{options:this.getAccentOptions(),current:i,onSubmit:async l=>{var d;await this.app.fileManager.processFrontMatter(e,h=>{h.accent=l}),await this.saveFileIfOpen(e),new u.Notice("accent \u5DF2\u66F4\u65B0\u3002",3e3),(d=this.publishView)==null||d.refresh()}}).open()}async updateFrontmatterFromForm(t,e){await this.app.fileManager.processFrontMatter(t,s=>{s.title=e.title.trim(),s.date=e.date.trim(),s.place=e.place.trim(),s.cover=e.cover.trim(),s.excerpt=e.excerpt.trim(),s.visibility=e.visibility,s.accent=e.accent.trim(),s.tags=I(e.tags)}),await this.saveFileIfOpen(t)}async unpublishCurrentFile(t){var n;let e=this.app.workspace.getActiveFile();if(!e||!this.isMarkdownFile(e)){new u.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Markdown \u6587\u4EF6\u3002",3e3);return}await this.saveFileIfOpen(e);let s=await this.readFrontmatter(e),a=this.suggestUnpublishSlug(e,(n=s.data)!=null?n:{})||await this.promptSlugInput("");a&&await this.unpublishBySlug(a,{deleteRemote:t.deleteRemote,sourceFile:e})}async unpublishBySlug(t,e){var s,i,a,n,l,d,h,m,f,b,S,w,D,c,p,F,C,T,B,L,M,P,W,H,_;if(!this.hasWebdavConfig()){new u.Notice("\u672A\u914D\u7F6E WebDAV\uFF0C\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u586B\u5199\u3002",4e3);return}(s=this.publishView)==null||s.setActionBusy(!0),(i=this.publishView)==null||i.resetPushProgress(),(a=this.publishView)==null||a.setStepStatus("validate","skipped","\u4E0B\u7EBF\u64CD\u4F5C"),(n=this.publishView)==null||n.setStepStatus("upload","skipped","\u65E0\u4E0A\u4F20"),e.deleteRemote||(l=this.publishView)==null||l.setStepStatus("delete","skipped","\u4EC5\u4E0B\u7EBF");try{(d=this.publishView)==null||d.setStepStatus("manifest","running","\u62C9\u53D6 manifest..."),(h=this.publishView)==null||h.setStatusMessage("\u6B63\u5728\u62C9\u53D6 manifest...");let $=await this.fetchManifestForUnpublish();if(!$){(m=this.publishView)==null||m.setStepStatus("manifest","error","\u8BFB\u53D6 manifest \u5931\u8D25");return}let k=$.items.find(y=>y.slug===t);if(!k){new u.Notice("\u8FDC\u7AEF manifest \u672A\u5305\u542B\u8BE5 slug\uFF0C\u53EF\u80FD\u4ECE\u672A\u53D1\u5E03\u6216\u5DF2\u4E0B\u7EBF\u3002",4e3),(f=this.publishView)==null||f.setStepStatus("manifest","success"),(b=this.publishView)==null||b.setStatusMessage("\u672A\u627E\u5230 slug");return}(S=this.publishView)==null||S.setStepStatus("manifest","success");let z=e.sourceFile?`${e.sourceFile.basename}.${e.sourceFile.extension}`:"",j=e.fileHint&&e.fileHint!==k.file||z&&z!==k.file?`\u8FDC\u7AEF\u6587\u4EF6\u540D\u4E0E\u672C\u5730\u4E0D\u540C\uFF0C\u5DF2\u6309\u8FDC\u7AEF\u8BB0\u5F55\u64CD\u4F5C\uFF08${k.file}\uFF09\u3002`:void 0;if(await this.promptUnpublishConfirm({mode:e.deleteRemote?"delete":"unpublish",slug:t,file:k.file,remotePath:`${this.settings.webdavContentDir}/${k.file}`,mismatchNote:j})!=="confirm"){(w=this.publishView)==null||w.setStatusMessage("\u5DF2\u53D6\u6D88\u64CD\u4F5C");return}let q=$.items.filter(y=>y.slug!==t),J=JSON.stringify({items:q},null,2)+`
`;(D=this.publishView)==null||D.setStepStatus("update","running","\u66F4\u65B0 manifest..."),(c=this.publishView)==null||c.setStatusMessage("\u6B63\u5728\u66F4\u65B0 manifest...");try{await this.webdav.putText([this.settings.webdavContentDir,this.settings.webdavManifestFile],J,"application/json; charset=utf-8"),(p=this.publishView)==null||p.setStepStatus("update","success")}catch(y){new u.Notice(this.formatWebDavError(y,"\u66F4\u65B0 manifest"),5e3),(F=this.publishView)==null||F.setStepStatus("update","error",this.formatWebDavError(y,"\u66F4\u65B0 manifest"));return}if(e.deleteRemote){(C=this.publishView)==null||C.setStepStatus("delete","running","\u5220\u9664/\u79FB\u52A8\u8FDC\u7AEF\u6587\u4EF6..."),(T=this.publishView)==null||T.setStatusMessage("\u6B63\u5728\u5220\u9664/\u79FB\u52A8\u8FDC\u7AEF\u6587\u4EF6...");let y=await this.deleteOrMoveRemoteFile(k.file);y.ok?(B=this.publishView)==null||B.setStepStatus("delete","success",y.message):((L=this.publishView)==null||L.setStepStatus("delete","error",y.message),new u.Notice(y.message,5e3)),(M=this.publishView)==null||M.setStatusMessage("\u4E0B\u7EBF/\u5220\u9664\u5B8C\u6210"),new u.Notice("\u5DF2\u5B8C\u6210\u4E0B\u7EBF\uFF08\u7F51\u7AD9\u5C06\u5728 ISR \u5468\u671F\u5185\u66F4\u65B0\uFF09\u3002",4e3)}else(P=this.publishView)==null||P.setStatusMessage("\u4E0B\u7EBF\u5B8C\u6210"),new u.Notice("\u5DF2\u4E0B\u7EBF\uFF08\u7F51\u7AD9\u5C06\u5728 ISR \u5468\u671F\u5185\u66F4\u65B0\uFF09\u3002",4e3);(W=this.publishView)==null||W.loadManifestPreview(),(H=this.publishView)==null||H.refreshFileStatus()}finally{(_=this.publishView)==null||_.setActionBusy(!1)}}resolveNewFileName(t,e){let s=t.trim(),i=`${e}-${O("milestone")}`,a=s||i;return/[\\/]/.test(a)?(new u.Notice("\u6587\u4EF6\u540D\u4E0D\u80FD\u5305\u542B\u659C\u6760\u3002",3e3),null):a.endsWith(`.${this.settings.defaultExtension}`)||a.includes(".")?a:`${a}.${this.settings.defaultExtension}`}humanizeTitleFromFilename(t){let e=t.replace(/^\d{4}-\d{2}-\d{2}-/,"");return e.replace(/[-_]+/g," ").trim()||e||"\u672A\u547D\u540D"}extractDateFromFilename(t){let e=t.match(/^(\d{4}-\d{2}-\d{2})/);return e&&R(e[1])?e[1]:null}extractExcerptFromContent(t){let s=t.replace(/^---\s*\n[\s\S]*?\n---\s*(\n|$)/,"").split(/\n\s*\n/).map(a=>a.trim()).filter(Boolean);if(s.length===0)return"";let i=s[0].replace(/\n+/g," ").trim();return i.length<=120?i:`${i.slice(0,120).trim()}...`}async ensureRemoteContentDir(){try{let t=this.settings.webdavContentDir.split("/").map(s=>s.trim()).filter(Boolean),e=[];for(let s of t)e.push(s),await this.webdav.ensureDirectory(e);return!0}catch(t){return new u.Notice(this.formatWebDavError(t,"\u521B\u5EFA\u8FDC\u7AEF\u76EE\u5F55"),5e3),!1}}async ensureRemoteTrashDir(){let t=this.settings.webdavTrashDir.trim()||"_trash",e=this.settings.webdavContentDir.split("/").map(a=>a.trim()).filter(Boolean),s=[];for(let a of e)s.push(a),await this.webdav.ensureDirectory(s);let i=[...s,t];return await this.webdav.ensureDirectory(i),i}async deleteOrMoveRemoteFile(t){try{return await this.webdav.deleteFile([this.settings.webdavContentDir,t]),{ok:!0,message:"\u5DF2\u5220\u9664\u8FDC\u7AEF\u6587\u4EF6\u3002"}}catch(e){let s=e instanceof v?e.status:void 0;return s===404?{ok:!1,message:"\u8FDC\u7AEF\u6587\u4EF6\u4E0D\u5B58\u5728\uFF0C\u5DF2\u4EC5\u4E0B\u7EBF\u3002"}:s===403||s===405||s===501?await this.moveRemoteFileToTrash(t):{ok:!1,message:this.formatWebDavError(e,"\u5220\u9664\u8FDC\u7AEF\u6587\u4EF6")}}}async moveRemoteFileToTrash(t){try{let s=[...await this.ensureRemoteTrashDir(),t];return await this.webdav.move([this.settings.webdavContentDir,t],s),{ok:!0,message:"\u5DF2\u79FB\u52A8\u5230\u56DE\u6536\u7AD9\u76EE\u5F55\u3002"}}catch(e){let s=e instanceof v?e.status:void 0;return s===404?{ok:!1,message:"\u8FDC\u7AEF\u6587\u4EF6\u4E0D\u5B58\u5728\uFF0C\u5DF2\u4EC5\u4E0B\u7EBF\u3002"}:s===403||s===405||s===501?{ok:!1,message:"\u670D\u52A1\u5668\u4E0D\u652F\u6301\u5220\u9664/\u79FB\u52A8\uFF0C\u5DF2\u4EC5\u4E0B\u7EBF\u3002"}:{ok:!1,message:this.formatWebDavError(e,"\u79FB\u52A8\u8FDC\u7AEF\u6587\u4EF6")}}}formatWebDavError(t,e){return t instanceof v?t.status===401||t.status===403?`${e}\u5931\u8D25\uFF1A\u9274\u6743\u5931\u8D25\uFF08HTTP ${t.status}\uFF09\uFF0C\u8BF7\u68C0\u67E5\u7528\u6237\u540D/\u5BC6\u7801\u3002`:t.status===408?`${e}\u5931\u8D25\uFF1A\u7F51\u7EDC\u8D85\u65F6\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5\u3002`:t.status===404?`${e}\u5931\u8D25\uFF1A\u8FDC\u7AEF\u8D44\u6E90\u4E0D\u5B58\u5728\uFF08HTTP 404\uFF09\u3002`:t.status?`${e}\u5931\u8D25\uFF1AHTTP ${t.status}`:`${e}\u5931\u8D25\uFF1A${t.message}`:t instanceof Error?`${e}\u5931\u8D25\uFF1A${t.message}`:`${e}\u5931\u8D25\uFF1A\u672A\u77E5\u9519\u8BEF\u3002`}};
